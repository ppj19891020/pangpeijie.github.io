<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">


  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2" rel="stylesheet">







<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="线上问题," />





  <link rel="alternate" href="/atom.xml" title="J~杰's Blog" type="application/atom+xml" />






<meta name="description" content="问题描述最近我们生产上的消息推送服务不断的爆出内存增长过大导致操作系统kill该进程，并且随着业务量的增长出现的频次越来越高，由去年12月底的半个月出现一次，到现在的一天出现一次。 该服务的业务逻辑就是消息推送，业务方推送消息，服务方通过rocketmq做削峰处理（之前使用kafka来左右消息队列没出现过问题），其中主要通道是个推和apns（使用pushy框架）通道，业务方的全局推送大概在5000">
<meta name="keywords" content="线上问题">
<meta property="og:type" content="article">
<meta property="og:title" content="线上服务堆外内存OOM问题">
<meta property="og:url" content="blog.ppjys.cn/2020/02/19/20200219_线上服务堆外内存OOM问题/index.html">
<meta property="og:site_name" content="J~杰&#39;s Blog">
<meta property="og:description" content="问题描述最近我们生产上的消息推送服务不断的爆出内存增长过大导致操作系统kill该进程，并且随着业务量的增长出现的频次越来越高，由去年12月底的半个月出现一次，到现在的一天出现一次。 该服务的业务逻辑就是消息推送，业务方推送消息，服务方通过rocketmq做削峰处理（之前使用kafka来左右消息队列没出现过问题），其中主要通道是个推和apns（使用pushy框架）通道，业务方的全局推送大概在5000">
<meta property="og:locale" content="default">
<meta property="og:image" content="/images/oom1.png">
<meta property="og:image" content="/images/oom4.png">
<meta property="og:image" content="/images/thread_inc.png">
<meta property="og:image" content="/images/oom2.png">
<meta property="og:image" content="/images/oom3.png">
<meta property="og:updated_time" content="2020-03-12T11:53:49.421Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="线上服务堆外内存OOM问题">
<meta name="twitter:description" content="问题描述最近我们生产上的消息推送服务不断的爆出内存增长过大导致操作系统kill该进程，并且随着业务量的增长出现的频次越来越高，由去年12月底的半个月出现一次，到现在的一天出现一次。 该服务的业务逻辑就是消息推送，业务方推送消息，服务方通过rocketmq做削峰处理（之前使用kafka来左右消息队列没出现过问题），其中主要通道是个推和apns（使用pushy框架）通道，业务方的全局推送大概在5000">
<meta name="twitter:image" content="/images/oom1.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="blog.ppjys.cn/2020/02/19/20200219_线上服务堆外内存OOM问题/"/>





  <title>线上服务堆外内存OOM问题 | J~杰's Blog</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="default">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband">
      <a href="https://github.com/ppj19891020"><img style="position: absolute; top: 0; left: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_left_green_007200.png" alt="Fork me on GitHub"></a>
    </div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">J~杰's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">人生就一条路，走一步有一步的景观</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-首页">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-分类">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-标签">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-归档">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-关于">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            Search
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="Searching..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="blog.ppjys.cn/2020/02/19/20200219_线上服务堆外内存OOM问题/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="J~杰">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="J~杰's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">线上服务堆外内存OOM问题</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-02-19T17:07:35+08:00">
                2020-02-19
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/快速排查线上问题/" itemprop="url" rel="index">
                    <span itemprop="name">快速排查线上问题</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          
            <span class="post-meta-divider">|</span>
            <span class="page-pv"><i class="fa fa-file-o"></i> 阅读数
            <span class="busuanzi-value" id="busuanzi_value_page_pv" ></span>
            </span>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h2><p>最近我们生产上的消息推送服务不断的爆出内存增长过大导致操作系统kill该进程，并且随着业务量的增长出现的频次越来越高，由去年12月底的半个月出现一次，到现在的一天出现一次。</p>
<p>该服务的业务逻辑就是消息推送，业务方推送消息，服务方通过rocketmq做削峰处理（<strong>之前使用kafka来左右消息队列没出现过问题</strong>），其中主要通道是个推和apns（使用pushy框架）通道，业务方的全局推送大概在5000w用户左右，每全局推送一次，内存就会增长几百mb，直到jvm进程内存达到5g之后，系统就会出现服务请求没响应或者被守护进程重启等问题。</p>
<p>刚开始的快速解决方案也只能重启，虽然重启能解决问题，但是也没找到根本原因！</p>
<h2 id="问题排查"><a href="#问题排查" class="headerlink" title="问题排查"></a>问题排查</h2><p>由于我们jvm堆内的初始内存和最大内存都是配置成2g ,但是进程的内存达到5g，那就是说堆外占了3g</p>
<blockquote>
<p>-Xms2048m -Xmx2048m</p>
</blockquote>
<h3 id="运维平台监控"><a href="#运维平台监控" class="headerlink" title="运维平台监控"></a>运维平台监控</h3><p>下面是运维监控平台的cpu、内存、线程资源数据，内存在一直在增长，没有回收释放。</p>
<p><img src="/images/oom1.png" alt="oom内存和cpu"></p>
<p>出问题的时候监控应用fullgc情况</p>
<p><img src="/images/oom4.png" alt="fullgc情况"></p>
<p>监控jvm虚拟机的线程增长情况</p>
<p><img src="/images/thread_inc.png" alt="线程增长情况"></p>
<a id="more"></a>
<h3 id="NMT监控"><a href="#NMT监控" class="headerlink" title="NMT监控"></a>NMT监控</h3><p>接下来我们就一直想知道这个增长的内存到底是啥，我们参考<a href="https://tech.meituan.com/2019/01/03/spring-boot-native-memory-leak.html" target="_blank" rel="noopener">Spring Boot引起的“堆外内存泄漏”排查及经验总结</a>文章来监控堆外内存,然后看了官方文档<a href="https://docs.oracle.com/javase/8/docs/technotes/guides/troubleshoot/tooldescr007.html#BABJGHDB" target="_blank" rel="noopener">How to Monitor VM Internal Memory</a>。</p>
<blockquote>
<p>jvm参数增加 “-XX:NativeMemoryTracking=detail”</p>
<p>然后在jvm启动成功后，执行命令”jcmd pid VM.native_memory baseline”设置基准。</p>
</blockquote>
<p>使用命令<code>jcmd pid VM.native_memory summary.diff</code>查看到的内存分布如下：</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">Native</span> <span class="selector-tag">Memory</span> <span class="selector-tag">Tracking</span>:</span><br><span class="line">Total: reserved=6292013KB +1539438KB, committed=5135497KB +1547890KB</span><br><span class="line"><span class="selector-tag">-</span>                 <span class="selector-tag">Java</span> <span class="selector-tag">Heap</span> (reserved=<span class="number">2097152</span>KB, committed=<span class="number">2097152</span>KB)</span><br><span class="line">                            (<span class="attribute">mmap</span>: reserved=<span class="number">2097152</span>KB, committed=<span class="number">2097152</span>KB)</span><br><span class="line"><span class="selector-tag">-</span>                     <span class="selector-tag">Class</span> (reserved=<span class="number">1195883</span>KB +<span class="number">2229</span>KB, committed=<span class="number">164035</span>KB +<span class="number">2229</span>KB)</span><br><span class="line">                            (classes <span class="number">#24637</span>)</span><br><span class="line">                            (malloc=<span class="number">14187</span>KB +<span class="number">181</span>KB <span class="number">#58583</span> -<span class="number">3174</span>)</span><br><span class="line">                            (<span class="attribute">mmap</span>: reserved=<span class="number">1181696</span>KB +<span class="number">2048</span>KB, committed=<span class="number">149848</span>KB +<span class="number">2048</span>KB)</span><br><span class="line"><span class="selector-tag">-</span>                    <span class="selector-tag">Thread</span> (reserved=<span class="number">330857</span>KB +<span class="number">16399</span>KB, committed=<span class="number">330857</span>KB +<span class="number">16399</span>KB)</span><br><span class="line">                            (thread <span class="number">#625</span> +<span class="number">32</span>)</span><br><span class="line">                            (<span class="attribute">stack</span>: reserved=<span class="number">328076</span>KB +<span class="number">16512</span>KB, committed=<span class="number">328076</span>KB +<span class="number">16512</span>KB)</span><br><span class="line">                            (malloc=<span class="number">2049</span>KB +<span class="number">105</span>KB <span class="number">#3129</span> +<span class="number">160</span>)</span><br><span class="line">                            (arena=<span class="number">732</span>KB -<span class="number">218</span> <span class="number">#1246</span> +<span class="number">64</span>)</span><br><span class="line"><span class="selector-tag">-</span>                      <span class="selector-tag">Code</span> (reserved=<span class="number">269720</span>KB -<span class="number">4533</span>KB, committed=<span class="number">145052</span>KB +<span class="number">3919</span>KB)</span><br><span class="line">                            (malloc=<span class="number">20120</span>KB -<span class="number">4533</span>KB <span class="number">#22197</span> -<span class="number">10586</span>)</span><br><span class="line">                            (<span class="attribute">mmap</span>: reserved=<span class="number">249600</span>KB, committed=<span class="number">124932</span>KB +<span class="number">8452</span>KB)</span><br><span class="line"><span class="selector-tag">-</span>                        <span class="selector-tag">GC</span> (reserved=<span class="number">85877</span>KB -<span class="number">1</span>KB, committed=<span class="number">85877</span>KB -<span class="number">1</span>KB)</span><br><span class="line">                            (malloc=<span class="number">9253</span>KB -<span class="number">1</span>KB <span class="number">#856</span> -<span class="number">42</span>)</span><br><span class="line">                            (<span class="attribute">mmap</span>: reserved=<span class="number">76624</span>KB, committed=<span class="number">76624</span>KB)</span><br><span class="line"><span class="selector-tag">-</span>                  <span class="selector-tag">Compiler</span> (reserved=<span class="number">1753</span>KB -<span class="number">159</span>KB, committed=<span class="number">1753</span>KB -<span class="number">159</span>KB)</span><br><span class="line">                            (malloc=<span class="number">1623</span>KB -<span class="number">159</span>KB <span class="number">#2892</span> -<span class="number">1291</span>)</span><br><span class="line">                            (arena=<span class="number">131</span>KB <span class="number">#6</span>)</span><br><span class="line"><span class="selector-tag">-</span>                  <span class="selector-tag">Internal</span> (reserved=<span class="number">2267668</span>KB +<span class="number">1520485</span>KB, committed=<span class="number">2267668</span>KB +<span class="number">1520485</span>KB)</span><br><span class="line">                            (malloc=<span class="number">2267636</span>KB +<span class="number">1520485</span>KB <span class="number">#39668</span> +<span class="number">996</span>)</span><br><span class="line">                            (<span class="attribute">mmap</span>: reserved=<span class="number">32</span>KB, committed=<span class="number">32</span>KB)</span><br><span class="line"><span class="selector-tag">-</span>                    <span class="selector-tag">Symbol</span> (reserved=<span class="number">30690</span>KB +<span class="number">10</span>KB, committed=<span class="number">30690</span>KB +<span class="number">10</span>KB)</span><br><span class="line">                            (malloc=<span class="number">26686</span>KB +<span class="number">10</span>KB <span class="number">#273270</span> +<span class="number">61</span>)</span><br><span class="line">                            (arena=<span class="number">4004</span>KB <span class="number">#1</span>)</span><br><span class="line"><span class="selector-tag">-</span>    <span class="selector-tag">Native</span> <span class="selector-tag">Memory</span> <span class="selector-tag">Tracking</span> (reserved=<span class="number">7216</span>KB +<span class="number">16</span>KB, committed=<span class="number">7216</span>KB +<span class="number">16</span>KB)</span><br><span class="line">                            (malloc=<span class="number">766</span>KB +<span class="number">190</span>KB <span class="number">#10648</span> +<span class="number">2568</span>)</span><br><span class="line">                            (tracking overhead=<span class="number">6450</span>KB -<span class="number">173</span>KB)</span><br><span class="line"><span class="selector-tag">-</span>               <span class="selector-tag">Arena</span> <span class="selector-tag">Chunk</span> (reserved=<span class="number">5196</span>KB +<span class="number">4991</span>KB, committed=<span class="number">5196</span>KB +<span class="number">4991</span>KB)</span><br><span class="line">                            (malloc=<span class="number">5196</span>KB +<span class="number">4991</span>KB)</span><br></pre></td></tr></table></figure>
<p>发现增长的区域居然是Internal区域，刚开始感到一脸疑惑，后来在网上看到<code>堆外内存申请也是属于Internal区域</code>，才觉得应该是什么中间件使用了堆外内存导致的内存泄漏。</p>
<h3 id="pmap查看内存分配情况"><a href="#pmap查看内存分配情况" class="headerlink" title="pmap查看内存分配情况"></a>pmap查看内存分配情况</h3><p> 通过linux工具查看进程的内存映射</p>
<blockquote>
<p>pmap -x 11305|sort -k 3 -n -r </p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="selector-tag">----------------</span> <span class="selector-tag">-------</span> <span class="selector-tag">-------</span> <span class="selector-tag">-------</span> </span><br><span class="line">&gt; <span class="selector-tag">0000000080000000</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span> <span class="selector-tag">rw---</span>   <span class="selector-attr">[ anon ]</span></span><br><span class="line">&gt; <span class="selector-tag">0000000101100000</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span> <span class="selector-tag">-----</span>   <span class="selector-attr">[ anon ]</span></span><br><span class="line">&gt; <span class="selector-tag">0000000101100000</span> <span class="selector-tag">1031168</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span> <span class="selector-tag">-----</span>   <span class="selector-attr">[ anon ]</span></span><br><span class="line">&gt; <span class="selector-tag">000055f7262ed000</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span> <span class="selector-tag">r-x--</span> <span class="selector-tag">java</span></span><br><span class="line">&gt; <span class="selector-tag">000055f7264ed000</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span> <span class="selector-tag">r----</span> <span class="selector-tag">java</span></span><br><span class="line">&gt; <span class="selector-tag">000055f7264ee000</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span> <span class="selector-tag">rw---</span> <span class="selector-tag">java</span></span><br><span class="line">&gt; <span class="selector-tag">000055f728243000</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span> <span class="selector-tag">rw---</span>   <span class="selector-attr">[ anon ]</span></span><br><span class="line">&gt; <span class="selector-tag">00007f6970000000</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span> <span class="selector-tag">rw---</span>   <span class="selector-attr">[ anon ]</span></span><br><span class="line">&gt; <span class="selector-tag">00007f6973003000</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span> <span class="selector-tag">-----</span>   <span class="selector-attr">[ anon ]</span></span><br><span class="line">&gt; <span class="selector-tag">00007f6973003000</span>   <span class="selector-tag">16372</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span> <span class="selector-tag">-----</span>   <span class="selector-attr">[ anon ]</span></span><br><span class="line">&gt; <span class="selector-tag">00007f6974000000</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span> <span class="selector-tag">rw---</span>   <span class="selector-attr">[ anon ]</span></span><br><span class="line">&gt; <span class="selector-tag">00007f6977010000</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span> <span class="selector-tag">-----</span>   <span class="selector-attr">[ anon ]</span></span><br><span class="line">&gt; <span class="selector-tag">00007f6977010000</span>   <span class="selector-tag">16320</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span> <span class="selector-tag">-----</span>   <span class="selector-attr">[ anon ]</span></span><br><span class="line">&gt; <span class="selector-tag">00007f6978000000</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span> <span class="selector-tag">rw---</span>   <span class="selector-attr">[ anon ]</span></span><br><span class="line">&gt; <span class="selector-tag">00007f697b001000</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span> <span class="selector-tag">-----</span>   <span class="selector-attr">[ anon ]</span></span><br><span class="line">&gt; <span class="selector-tag">00007f697b001000</span>   <span class="selector-tag">16380</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span> <span class="selector-tag">-----</span>   <span class="selector-attr">[ anon ]</span></span><br><span class="line">&gt; <span class="selector-tag">00007f697c000000</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span> <span class="selector-tag">rw---</span>   <span class="selector-attr">[ anon ]</span></span><br><span class="line">&gt; <span class="selector-tag">00007f697e001000</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span> <span class="selector-tag">-----</span>   <span class="selector-attr">[ anon ]</span></span><br><span class="line">&gt; <span class="selector-tag">00007f697e001000</span>   <span class="selector-tag">32764</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span> <span class="selector-tag">-----</span>   <span class="selector-attr">[ anon ]</span></span><br><span class="line">&gt; <span class="selector-tag">00007f6980000000</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span> <span class="selector-tag">rw---</span>   <span class="selector-attr">[ anon ]</span></span><br><span class="line">&gt; <span class="selector-tag">00007f6983001000</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span> <span class="selector-tag">-----</span>   <span class="selector-attr">[ anon ]</span></span><br><span class="line">&gt; <span class="selector-tag">00007f6983001000</span>   <span class="selector-tag">16380</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span> <span class="selector-tag">-----</span>   <span class="selector-attr">[ anon ]</span></span><br><span class="line">&gt; <span class="selector-tag">00007f6988000000</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span> <span class="selector-tag">rw---</span>   <span class="selector-attr">[ anon ]</span></span><br><span class="line">&gt; <span class="selector-tag">00007f698b001000</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span> <span class="selector-tag">-----</span>   <span class="selector-attr">[ anon ]</span></span><br><span class="line">&gt; <span class="selector-tag">00007f698b001000</span>   <span class="selector-tag">16380</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span> <span class="selector-tag">-----</span>   <span class="selector-attr">[ anon ]</span></span><br><span class="line">&gt; <span class="selector-tag">00007f698c000000</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span> <span class="selector-tag">rw---</span>   <span class="selector-attr">[ anon ]</span></span><br><span class="line">&gt; <span class="selector-tag">00007f698f001000</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span> <span class="selector-tag">-----</span>   <span class="selector-attr">[ anon ]</span></span><br><span class="line">&gt; <span class="selector-tag">00007f698f001000</span>   <span class="selector-tag">16380</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span> <span class="selector-tag">-----</span>   <span class="selector-attr">[ anon ]</span></span><br><span class="line">&gt; <span class="selector-tag">00007f6990000000</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span> <span class="selector-tag">rw---</span>   <span class="selector-attr">[ anon ]</span></span><br><span class="line">&gt; <span class="selector-tag">00007f6993001000</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span> <span class="selector-tag">-----</span>   <span class="selector-attr">[ anon ]</span></span><br><span class="line">&gt; <span class="selector-tag">00007f6993001000</span>   <span class="selector-tag">16380</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span> <span class="selector-tag">-----</span>   <span class="selector-attr">[ anon ]</span></span><br><span class="line">&gt; <span class="selector-tag">00007f6994000000</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span> <span class="selector-tag">rw---</span>   <span class="selector-attr">[ anon ]</span></span><br><span class="line">&gt; <span class="selector-tag">00007f6997001000</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span> <span class="selector-tag">-----</span>   <span class="selector-attr">[ anon ]</span></span><br><span class="line">&gt; <span class="selector-tag">00007f6997001000</span>   <span class="selector-tag">16380</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span> <span class="selector-tag">-----</span>   <span class="selector-attr">[ anon ]</span></span><br><span class="line">&gt; <span class="selector-tag">00007f6998000000</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span> <span class="selector-tag">rw---</span>   <span class="selector-attr">[ anon ]</span></span><br><span class="line">&gt; <span class="selector-tag">00007f699b001000</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span> <span class="selector-tag">-----</span>   <span class="selector-attr">[ anon ]</span></span><br><span class="line">&gt; <span class="selector-tag">00007f699b001000</span>   <span class="selector-tag">16380</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span> <span class="selector-tag">-----</span>   <span class="selector-attr">[ anon ]</span></span><br><span class="line">&gt; <span class="selector-tag">00007f699c000000</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span> <span class="selector-tag">rw---</span>   <span class="selector-attr">[ anon ]</span></span><br><span class="line">&gt; <span class="selector-tag">00007f699f001000</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span> <span class="selector-tag">-----</span>   <span class="selector-attr">[ anon ]</span></span><br><span class="line">&gt; <span class="selector-tag">00007f699f001000</span>   <span class="selector-tag">16380</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span> <span class="selector-tag">-----</span>   <span class="selector-attr">[ anon ]</span></span><br><span class="line">&gt; <span class="selector-tag">00007f69a0000000</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span> <span class="selector-tag">rw---</span>   <span class="selector-attr">[ anon ]</span></span><br><span class="line">&gt; <span class="selector-tag">00007f69a3001000</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span> <span class="selector-tag">-----</span>   <span class="selector-attr">[ anon ]</span></span><br><span class="line">&gt; <span class="selector-tag">00007f69a3001000</span>   <span class="selector-tag">16380</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span> <span class="selector-tag">-----</span>   <span class="selector-attr">[ anon ]</span></span><br><span class="line">&gt; <span class="selector-tag">00007f69a4000000</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span> <span class="selector-tag">rw---</span>   <span class="selector-attr">[ anon ]</span></span><br><span class="line">&gt; <span class="selector-tag">00007f69a7001000</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span> <span class="selector-tag">-----</span>   <span class="selector-attr">[ anon ]</span></span><br><span class="line">&gt; <span class="selector-tag">00007f69a7001000</span>   <span class="selector-tag">16380</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span> <span class="selector-tag">-----</span>   <span class="selector-attr">[ anon ]</span></span><br><span class="line">&gt; <span class="selector-tag">00007f69a8000000</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span> <span class="selector-tag">rw---</span>   <span class="selector-attr">[ anon ]</span></span><br><span class="line">&gt; <span class="selector-tag">00007f69ab001000</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span> <span class="selector-tag">-----</span>   <span class="selector-attr">[ anon ]</span></span><br><span class="line">&gt; <span class="selector-tag">00007f69ab001000</span>   <span class="selector-tag">16380</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span> <span class="selector-tag">-----</span>   <span class="selector-attr">[ anon ]</span></span><br><span class="line">&gt; <span class="selector-tag">00007f69ada9a000</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span> <span class="selector-tag">rw---</span>   <span class="selector-attr">[ anon ]</span></span><br><span class="line">&gt; <span class="selector-tag">00007f69afa9c000</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span> <span class="selector-tag">-----</span>   <span class="selector-attr">[ anon ]</span></span><br><span class="line">&gt; <span class="selector-tag">00007f69afa9c000</span>      <span class="selector-tag">12</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span> <span class="selector-tag">-----</span>   <span class="selector-attr">[ anon ]</span></span><br><span class="line">&gt; <span class="selector-tag">00007f69afa9f000</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span> <span class="selector-tag">rw---</span>   <span class="selector-attr">[ anon ]</span></span><br><span class="line">&gt; <span class="selector-tag">00007f69afb1d000</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span> <span class="selector-tag">-----</span>   <span class="selector-attr">[ anon ]</span></span><br><span class="line">&gt; <span class="selector-tag">00007f69afb1d000</span>      <span class="selector-tag">12</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span> <span class="selector-tag">-----</span>   <span class="selector-attr">[ anon ]</span></span><br><span class="line">&gt; <span class="selector-tag">00007f69afb20000</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span> <span class="selector-tag">rw---</span>   <span class="selector-attr">[ anon ]</span></span><br><span class="line">&gt; <span class="selector-tag">00007f69afb9e000</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span> <span class="selector-tag">-----</span>   <span class="selector-attr">[ anon ]</span></span><br><span class="line">&gt; <span class="selector-tag">00007f69afb9e000</span>      <span class="selector-tag">12</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span> <span class="selector-tag">-----</span>   <span class="selector-attr">[ anon ]</span></span><br><span class="line">&gt; <span class="selector-tag">00007f69afba1000</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span> <span class="selector-tag">rw---</span>   <span class="selector-attr">[ anon ]</span></span><br><span class="line">&gt; <span class="selector-tag">00007f69afc1f000</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span> <span class="selector-tag">-----</span>   <span class="selector-attr">[ anon ]</span></span><br><span class="line">&gt; <span class="selector-tag">00007f69afc1f000</span>      <span class="selector-tag">12</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span> <span class="selector-tag">-----</span>   <span class="selector-attr">[ anon ]</span></span><br><span class="line">&gt; <span class="selector-tag">00007f69afc22000</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span> <span class="selector-tag">rw---</span>   <span class="selector-attr">[ anon ]</span></span><br><span class="line">&gt; <span class="selector-tag">00007f69afda2000</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span> <span class="selector-tag">-----</span>   <span class="selector-attr">[ anon ]</span></span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<p>备注：由于篇幅问题，该地方只截取了部分。</p>
<p>从以上也没看出有啥特别多的内存块，所以这里也不好怀疑。</p>
</blockquote>
<h3 id="操作系统工具分析"><a href="#操作系统工具分析" class="headerlink" title="操作系统工具分析"></a>操作系统工具分析</h3><p>由于操作系统监控运维不给装，我们也就放弃这方面的定位了，这边就写一下大概的思路。</p>
<blockquote>
<p>1.使用strace去追踪系统调用 </p>
<p>2.使用GDB去dump可疑内存 </p>
<p>3.使用jstack去查看对应的线程</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="selector-tag">strace</span>: <span class="selector-tag">Process</span> <span class="selector-tag">11305</span> <span class="selector-tag">attached</span> <span class="selector-tag">with</span> <span class="selector-tag">442</span> <span class="selector-tag">threads</span></span><br><span class="line">&gt; <span class="selector-tag">strace</span>: <span class="selector-attr">[ Process PID=11314 runs in x32 mode. ]</span></span><br><span class="line">&gt; <span class="selector-tag">strace</span>: <span class="selector-attr">[ Process PID=11312 runs in x32 mode. ]</span></span><br><span class="line">&gt; <span class="selector-tag">strace</span>: <span class="selector-attr">[ Process PID=11314 runs in 64 bit mode. ]</span></span><br><span class="line">&gt; <span class="selector-tag">strace</span>: <span class="selector-attr">[ Process PID=11308 runs in x32 mode. ]</span></span><br><span class="line">&gt; <span class="selector-tag">strace</span>: <span class="selector-attr">[ Process PID=11312 runs in 64 bit mode. ]</span></span><br><span class="line">&gt; <span class="selector-tag">strace</span>: <span class="selector-attr">[ Process PID=11307 runs in x32 mode. ]</span></span><br><span class="line">&gt; <span class="selector-tag">strace</span>: <span class="selector-attr">[ Process PID=11307 runs in 64 bit mode. ]</span></span><br><span class="line">&gt; <span class="selector-tag">strace</span>: <span class="selector-attr">[ Process PID=11308 runs in 64 bit mode. ]</span></span><br><span class="line">&gt; [pid 11453] --- SIGSEGV &#123;si_signo=SIGSEGV, si_code=SEGV_MAPERR, si_addr=0x8&#125; ---</span><br><span class="line">&gt; [pid 11453] --- SIGSEGV &#123;si_signo=SIGSEGV, si_code=SEGV_MAPERR, si_addr=0x8&#125; ---</span><br><span class="line">&gt; [pid 11453] --- SIGSEGV &#123;si_signo=SIGSEGV, si_code=SEGV_MAPERR, si_addr=0x8&#125; ---</span><br><span class="line">&gt; [pid 11452] mmap(NULL, 8329, PROT_READ, MAP_SHARED, 296, 0x12000) = 0x7ff8c036b000</span><br><span class="line">&gt; [pid 11462] --- SIGSEGV &#123;si_signo=SIGSEGV, si_code=SEGV_MAPERR, si_addr=0xc&#125; ---</span><br><span class="line">&gt; [pid 11452] mmap(NULL, 3482, PROT_READ, MAP_SHARED, 186, 0) = 0x7ff8c0672000</span><br><span class="line">&gt; [pid 11452] mmap(NULL, 8742, PROT_READ, MAP_SHARED, 189, 0x14000) = 0x7ff8c0368000</span><br><span class="line">&gt; [pid 11452] mmap(NULL, 19304, PROT_READ, MAP_SHARED, 192, 0x68000) = 0x7ff8c0363000</span><br><span class="line">&gt; [pid 11485] --- SIGSEGV &#123;si_signo=SIGSEGV, si_code=SEGV_ACCERR, si_addr=0x7ff8e901fc00&#125; ---</span><br><span class="line">&gt; [pid 11452] mmap(NULL, 25507, PROT_READ, MAP_SHARED, 302, 0x4c000) = 0x7ff8c035c000</span><br><span class="line">&gt; [pid 11452] mmap(NULL, 2164, PROT_READ, MAP_SHARED, 306, 0) = 0x7ff8c035b000</span><br><span class="line">&gt; [pid 11452] mmap(NULL, 99469, PROT_READ, MAP_SHARED, 307, 0x1bf000) = 0x7ff8c0342000</span><br><span class="line">&gt; [pid 11452] mmap(NULL, 15813, PROT_READ, MAP_SHARED, 308, 0x35000) = 0x7ff8c033e000</span><br><span class="line">&gt; [pid 11452] mmap(NULL, 27163, PROT_READ, MAP_SHARED, 309, 0x38000) = 0x7ff8c0337000</span><br><span class="line">&gt; [pid 11452] mmap(NULL, 2155, PROT_READ, MAP_SHARED, 310, 0x2000) = 0x7ff8c0336000</span><br><span class="line">&gt; [pid 11452] mmap(NULL, 9433, PROT_READ, MAP_SHARED, 311, 0x18000) = 0x7ff8c0333000</span><br><span class="line">&gt; [pid 11452] mmap(NULL, 4679, PROT_READ, MAP_SHARED, 312, 0x15000) = 0x7ff8c0331000</span><br><span class="line">&gt; [pid 11452] mmap(NULL, 8824, PROT_READ, MAP_SHARED, 314, 0x21000) = 0x7ff8c032e000</span><br><span class="line">&gt; [pid 11452] mmap(NULL, 26825, PROT_READ, MAP_SHARED, 315, 0x73000) = 0x7ff8c0327000</span><br><span class="line">&gt; [pid 11452] mmap(NULL, 6971, PROT_READ, MAP_SHARED, 316, 0x6000) = 0x7ff8c0023000</span><br><span class="line">&gt; [pid 11452] mmap(NULL, 7756, PROT_READ, MAP_SHARED, 317, 0xe000) = 0x7ff8c0021000</span><br><span class="line">&gt; [pid 11452] mmap(NULL, 16798, PROT_READ, MAP_SHARED, 318, 0x38000) = 0x7ff8c001c000</span><br><span class="line">&gt; [pid 11452] mmap(NULL, 14199, PROT_READ, MAP_SHARED, 319, 0x2f000) = 0x7ff8c0018000</span><br><span class="line">&gt; [pid 11452] mmap(NULL, 26136, PROT_READ, MAP_SHARED, 320, 0x3f000) = 0x7ff8c0011000</span><br><span class="line">&gt; [pid 11452] mmap(NULL, 51761, PROT_READ, MAP_SHARED, 321, 0x83000) = 0x7ff8c0004000</span><br><span class="line">&gt; [pid 11452] mmap(NULL, 60574, PROT_READ, MAP_SHARED, 322, 0xa9000) = 0x7ff8b8de4000</span><br><span class="line">&gt; [pid 11452] mmap(NULL, 26807, PROT_READ, MAP_SHARED, 323, 0x52000) = 0x7ff8b8ddd000</span><br><span class="line">&gt; [pid 11452] mmap(NULL, 7562, PROT_READ, MAP_SHARED, 324, 0xf000) = 0x7ff8c0002000</span><br><span class="line">&gt; [pid 11452] mmap(NULL, 22377, PROT_READ, MAP_SHARED, 325, 0x45000) = 0x7ff8b8dd7000</span><br><span class="line">&gt; [pid 11452] mmap(NULL, 13843, PROT_READ, MAP_SHARED, 326, 0x27000) = 0x7ff8b8dd3000</span><br><span class="line">&gt; [pid 11452] mmap(NULL, 16049, PROT_READ, MAP_SHARED, 327, 0x3c000) = 0x7ff8b8dcf000</span><br><span class="line">&gt; [pid 11452] mmap(NULL, 32840, PROT_READ, MAP_SHARED, 328, 0x73000) = 0x7ff8b8dc6000</span><br><span class="line">&gt; [pid 11452] mmap(NULL, 7438, PROT_READ, MAP_SHARED, 329, 0xd000) = 0x7ff8c0000000</span><br><span class="line">&gt; [pid 11452] mmap(NULL, 12333, PROT_READ, MAP_SHARED, 330, 0x1c000) = 0x7ff8b8dc2000</span><br><span class="line">&gt; [pid 11452] mmap(NULL, 244913, PROT_READ, MAP_SHARED, 331, 0x24d000) = 0x7ff8b8027000</span><br><span class="line">&gt; [pid 11452] mmap(NULL, 33213, PROT_READ, MAP_SHARED, 332, 0x43000) = 0x7ff8b8db9000</span><br><span class="line">&gt; [pid 11452] mmap(NULL, 28353, PROT_READ, MAP_SHARED, 333, 0x41000) = 0x7ff8b837b000</span><br><span class="line">&gt; [pid 11452] mmap(NULL, 9944, PROT_READ, MAP_SHARED, 334, 0x11000) = 0x7ff8b8db6000</span><br><span class="line">&gt; [pid 11452] mmap(NULL, 18986, PROT_READ, MAP_SHARED, 335, 0x48000) = 0x7ff8b8376000</span><br><span class="line">&gt; [pid 11452] mmap(NULL, 21674, PROT_READ, MAP_SHARED, 336, 0x3e000) = 0x7ff8b8370000</span><br><span class="line">&gt; [pid 11452] mmap(NULL, 136760, PROT_READ, MAP_SHARED, 337, 0x1f1000) = 0x7ff8b8005000</span><br><span class="line">&gt; [pid 11452] mmap(NULL, 5109, PROT_READ, MAP_SHARED, 338, 0x4000) = 0x7ff8b836e000</span><br><span class="line">&gt; [pid 11452] mmap(NULL, 3686, PROT_READ, MAP_SHARED, 339, 0) = 0x7ff8b836d000</span><br><span class="line">&gt; [pid 11452] mmap(NULL, 4542, PROT_READ, MAP_SHARED, 340, 0x5000) = 0x7ff8b836b000</span><br><span class="line">&gt; [pid 11452] mmap(NULL, 1280, PROT_READ, MAP_SHARED, 341, 0x1000) = 0x7ff8b836a000</span><br><span class="line">&gt; [pid 11452] mmap(NULL, 8572, PROT_READ, MAP_SHARED, 342, 0xb000) = 0x7ff8b8367000</span><br><span class="line">&gt; [pid 11452] mmap(NULL, 893527, PROT_READ, MAP_SHARED, 343, 0x7c4000) = 0x7ff7485e6000</span><br><span class="line">&gt; [pid 11452] mmap(NULL, 5512, PROT_READ, MAP_SHARED, 344, 0x2000) = 0x7ff8b8365000</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
</blockquote>
<h3 id="内存堆栈分析"><a href="#内存堆栈分析" class="headerlink" title="内存堆栈分析"></a>内存堆栈分析</h3><p>由于系统层面堆栈无法分析，我们只能考虑dump内存，如果是堆外内存，肯定有堆内的引用，此时也只能这样操作。</p>
<blockquote>
<p>jmap -heap pid</p>
<p>jmap -histo:live pid | more</p>
<p>jmap -dump:format=b,file=/filetransfer/heap.hprof</p>
</blockquote>
<p>以下是通过jprofile的分析图</p>
<p><img src="/images/oom2.png" alt="大对象图"></p>
<p><img src="/images/oom3.png" alt="nioEventLoop引用分析"></p>
<p>经过以上分析我们能分析出堆内存在大对象是apns推送相关，我们苹果推送用的是pushy框架，此时发现需要看关注下业务代码发送逻辑和pushy源码相关。</p>
<h3 id="问题分析"><a href="#问题分析" class="headerlink" title="问题分析"></a>问题分析</h3><h4 id="pushy消息内存堆积"><a href="#pushy消息内存堆积" class="headerlink" title="pushy消息内存堆积"></a>pushy消息内存堆积</h4><p>查阅了pushy的官方文档，发现框架为了提高总的tps，本身做了一层消息缓存功能，以下是官方文档摘录。</p>
<blockquote>
<p>The APNs server allows for (at the time of this writing) 1,500 notifications in flight at any time. If we hit that limit, Pushy will buffer notifications automatically behind the scenes and send them to the server as in-flight notifications are resolved.</p>
</blockquote>
<blockquote>
<p>In short, asynchronous operation allows Pushy to make the most of local resources (especially CPU time) by sending notifications as quickly as possible.</p>
</blockquote>
<p>然后看了业务代码逻辑，<strong>rocketmq消费者消费tps比较高，然后真正推送的时候是直接采用异步的时候推送，这时候导致会存在大量的futuretask回调，而且监听器回调里居然还有while(trysave()){sleep(2000)}方法，导致回调的tps很低，大量的futuretask都积压在内存</strong>，伪代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//发送anps服务器</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">send</span><span class="params">(<span class="keyword">final</span> Notification notification)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">final</span> String topic = notification.getTopic();</span><br><span class="line">  <span class="keyword">final</span> String deviceToken = notification.getDeviceToken();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">final</span> ApnsPayloadBuilder builder = <span class="keyword">new</span> ApnsPayloadBuilder();</span><br><span class="line">  builder</span><br><span class="line">    .setAlertTitle(notification.getTitle())</span><br><span class="line">    .setAlertBody(notification.getDescription()).setMutableContent(<span class="keyword">true</span>)</span><br><span class="line">    .addCustomProperty(<span class="string">"*****"</span>, String.valueOf(notification.getTraceId()));</span><br><span class="line"></span><br><span class="line">  <span class="keyword">final</span> Map&lt;String, Object&gt; properties = CommonHelper.Json2Map(notification.getPayload());</span><br><span class="line">  setProperties(properties, builder);</span><br><span class="line">  <span class="keyword">final</span> String payload = builder.buildWithDefaultMaximumLength();</span><br><span class="line">  <span class="keyword">final</span> Future&lt;PushNotificationResponse&lt;SimpleApnsPushNotification&gt;&gt; notificationResponseFuture =</span><br><span class="line">    client.sendNotification(<span class="keyword">new</span> SimpleApnsPushNotification(deviceToken, topic, payload));</span><br><span class="line"></span><br><span class="line">  notificationResponseFuture.addListener(future -&gt; &#123;</span><br><span class="line">    NotificationStatus status = NotificationStatus.FAILED;</span><br><span class="line">    PushyNotificationService.count.decrementAndGet();</span><br><span class="line">    <span class="keyword">if</span> (future.isSuccess()) &#123;</span><br><span class="line">      <span class="keyword">final</span> PushNotificationResponse&lt;SimpleApnsPushNotification&gt; response =</span><br><span class="line">        (PushNotificationResponse&lt;SimpleApnsPushNotification&gt;) future.get();</span><br><span class="line">      <span class="keyword">if</span> (response.isAccepted()) &#123;</span><br><span class="line">        status = NotificationStatus.RECEIVED;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        log.info(<span class="string">"failed reason: &#123;&#125;, notification: &#123;&#125;"</span>, response.getRejectionReason(),</span><br><span class="line">                 ReflectionToStringBuilder.toString(notification));</span><br><span class="line">        notification.setFailedReason(response.getRejectionReason());</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      status = NotificationStatus.RETRY;</span><br><span class="line">      <span class="keyword">final</span> String errorMessage = future.cause().getMessage();</span><br><span class="line">      <span class="comment">// 处理 apns 证书过期情况</span></span><br><span class="line">      <span class="keyword">if</span> (StringUtil.isNotEmpty(errorMessage) &amp;&amp; errorMessage.contains(ERROR_CERT_EXPIRE)) &#123;</span><br><span class="line">        status = NotificationStatus.FAILED;</span><br><span class="line">        notification.setFailedReason(ERROR_CERT_EXPIRE);</span><br><span class="line">      &#125;</span><br><span class="line">      log.warn(<span class="string">"pushy send notification failed... &#123;&#125;"</span>, errorMessage);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">      notification.setNotificationStatus(status);</span><br><span class="line">      operator.postSendOperate(notification);</span><br><span class="line">    &#125;<span class="keyword">catch</span> (Exception ex)&#123;</span><br><span class="line">      log.error(<span class="string">"apns response error"</span>,ex);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//回调方法</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postSendOperate</span><span class="params">(<span class="keyword">final</span> BatchNotificationWrapper notification)</span> </span>&#123;</span><br><span class="line">  <span class="comment">//省略......</span></span><br><span class="line">  <span class="keyword">while</span> (!messageService.trySave(msg)) &#123;</span><br><span class="line">    CommonHelper.sleep(<span class="number">2000</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//省略......</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最终我们在发送代码里加入限流逻辑和优化回调方法，最终发版上线，观察了1天后还未发现内存异常，不过还需要持续关注，就怕pushy会存在内存泄漏问题。<a href="https://www.jianshu.com/p/2f71690ff473" target="_blank" rel="noopener">参考pushy最佳实践</a></p>
<h4 id="threadlocal内存泄漏"><a href="#threadlocal内存泄漏" class="headerlink" title="threadlocal内存泄漏"></a>threadlocal内存泄漏</h4><p>发现业务代码中有使用threadlocal操作，但是没有使用remove，这可能会出现堆内存泄漏问题，由于threadlocal使用的ThreadLocal.ThreadLocalMap只有gc的时候回收弱引用。参考<a href="https://www.jianshu.com/p/1342a879f523" target="_blank" rel="noopener">深入分析 ThreadLocal 内存泄漏问题</a>.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadLocalMap</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * The entries in this hash map extend WeakReference, using</span></span><br><span class="line"><span class="comment">         * its main ref field as the key (which is always a</span></span><br><span class="line"><span class="comment">         * ThreadLocal object).  Note that null keys (i.e. entry.get()</span></span><br><span class="line"><span class="comment">         * == null) mean that the key is no longer referenced, so the</span></span><br><span class="line"><span class="comment">         * entry can be expunged from table.  Such entries are referred to</span></span><br><span class="line"><span class="comment">         * as "stale entries" in the code that follows.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Entry</span> <span class="keyword">extends</span> <span class="title">WeakReference</span>&lt;<span class="title">ThreadLocal</span>&lt;?&gt;&gt; </span>&#123;</span><br><span class="line">            <span class="comment">/** The value associated with this ThreadLocal. */</span></span><br><span class="line">            Object value;</span><br><span class="line"></span><br><span class="line">            Entry(ThreadLocal&lt;?&gt; k, Object v) &#123;</span><br><span class="line">                <span class="keyword">super</span>(k);</span><br><span class="line">                value = v;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>
<h4 id="线程泄漏问题"><a href="#线程泄漏问题" class="headerlink" title="线程泄漏问题"></a>线程泄漏问题</h4><p>线上环境线程比较发现netty包中的nioEventLoopGroup增长了将近300个线程，占总线程数的40%，分析了项目中除了rocket-mq-clinet，就是apns苹果推送，最终定位到apns推送每一次实例化apnsClient就会new 4个nioEventLoopGroup线程，项目总共有将近30个苹果推送的渠道，如果按照这个算法应该也就4*30=120个nioEventLoopGroup线程，但是实际远远超过这个线程，接下来我们继续看源码中问题。</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line">Mar  4 11:55:02 pay3 push[13039]: "nioEventLoopGroup-21-4" #8729 prio=10 os_prio=0 tid=0x00007f22e4002800 nid=0x5b0e runnable [0x00007f22ac0c9000]</span><br><span class="line"><span class="selector-tag">Mar</span>  <span class="selector-tag">4</span> <span class="selector-tag">11</span><span class="selector-pseudo">:55</span><span class="selector-pseudo">:02</span> <span class="selector-tag">pay3</span> <span class="selector-tag">push</span><span class="selector-attr">[13039]</span>:    <span class="selector-tag">java</span><span class="selector-class">.lang</span><span class="selector-class">.Thread</span><span class="selector-class">.State</span>: <span class="selector-tag">RUNNABLE</span></span><br><span class="line"><span class="selector-tag">Mar</span>  <span class="selector-tag">4</span> <span class="selector-tag">11</span><span class="selector-pseudo">:55</span><span class="selector-pseudo">:02</span> <span class="selector-tag">pay3</span> <span class="selector-tag">push</span><span class="selector-attr">[13039]</span>: <span class="selector-id">#011at</span> <span class="selector-tag">sun</span><span class="selector-class">.nio</span><span class="selector-class">.ch</span><span class="selector-class">.SelectorImpl</span><span class="selector-class">.select</span>(SelectorImpl.<span class="attribute">java</span>:<span class="number">97</span>)</span><br><span class="line"><span class="selector-tag">Mar</span>  <span class="selector-tag">4</span> <span class="selector-tag">11</span><span class="selector-pseudo">:55</span><span class="selector-pseudo">:02</span> <span class="selector-tag">pay3</span> <span class="selector-tag">push</span><span class="selector-attr">[13039]</span>: <span class="selector-id">#011at</span> <span class="selector-tag">io</span><span class="selector-class">.netty</span><span class="selector-class">.channel</span><span class="selector-class">.nio</span><span class="selector-class">.SelectedSelectionKeySetSelector</span><span class="selector-class">.select</span>(SelectedSelectionKeySetSelector.<span class="attribute">java</span>:<span class="number">62</span>)</span><br><span class="line"><span class="selector-tag">Mar</span>  <span class="selector-tag">4</span> <span class="selector-tag">11</span><span class="selector-pseudo">:55</span><span class="selector-pseudo">:02</span> <span class="selector-tag">pay3</span> <span class="selector-tag">push</span><span class="selector-attr">[13039]</span>: <span class="selector-id">#011at</span> <span class="selector-tag">io</span><span class="selector-class">.netty</span><span class="selector-class">.channel</span><span class="selector-class">.nio</span><span class="selector-class">.NioEventLoop</span><span class="selector-class">.select</span>(NioEventLoop.<span class="attribute">java</span>:<span class="number">806</span>)</span><br><span class="line"><span class="selector-tag">Mar</span>  <span class="selector-tag">4</span> <span class="selector-tag">11</span><span class="selector-pseudo">:55</span><span class="selector-pseudo">:02</span> <span class="selector-tag">pay3</span> <span class="selector-tag">push</span><span class="selector-attr">[13039]</span>: <span class="selector-id">#011at</span> <span class="selector-tag">io</span><span class="selector-class">.netty</span><span class="selector-class">.channel</span><span class="selector-class">.nio</span><span class="selector-class">.NioEventLoop</span><span class="selector-class">.run</span>(NioEventLoop.<span class="attribute">java</span>:<span class="number">454</span>)</span><br><span class="line">Mar  4 11:55:02 pay3 push[13039]: #011at io.netty.util.concurrent.SingleThreadEventExecutor$5.run(SingleThreadEventExecutor.java:918)</span><br><span class="line">Mar  4 11:55:02 pay3 push[13039]: #011at io.netty.util.internal.ThreadExecutorMap$2.run(ThreadExecutorMap.java:74)</span><br><span class="line"><span class="selector-tag">Mar</span>  <span class="selector-tag">4</span> <span class="selector-tag">11</span><span class="selector-pseudo">:55</span><span class="selector-pseudo">:02</span> <span class="selector-tag">pay3</span> <span class="selector-tag">push</span><span class="selector-attr">[13039]</span>: <span class="selector-id">#011at</span> <span class="selector-tag">io</span><span class="selector-class">.netty</span><span class="selector-class">.util</span><span class="selector-class">.concurrent</span><span class="selector-class">.FastThreadLocalRunnable</span><span class="selector-class">.run</span>(FastThreadLocalRunnable.<span class="attribute">java</span>:<span class="number">30</span>)</span><br><span class="line"><span class="selector-tag">Mar</span>  <span class="selector-tag">4</span> <span class="selector-tag">11</span><span class="selector-pseudo">:55</span><span class="selector-pseudo">:02</span> <span class="selector-tag">pay3</span> <span class="selector-tag">push</span><span class="selector-attr">[13039]</span>: <span class="selector-id">#011at</span> <span class="selector-tag">java</span><span class="selector-class">.lang</span><span class="selector-class">.Thread</span><span class="selector-class">.run</span>(Thread.<span class="attribute">java</span>:<span class="number">748</span>)</span><br><span class="line"><span class="selector-tag">Mar</span>  <span class="selector-tag">4</span> <span class="selector-tag">11</span><span class="selector-pseudo">:55</span><span class="selector-pseudo">:02</span> <span class="selector-tag">pay3</span> <span class="selector-tag">push</span><span class="selector-attr">[13039]</span>: </span><br><span class="line">Mar  4 11:55:02 pay3 push[13039]: "nioEventLoopGroup-21-2" #8727 prio=10 os_prio=0 tid=0x00007f22dc13d000 nid=0x5b0c runnable [0x00007f22ab349000]</span><br><span class="line"><span class="selector-tag">Mar</span>  <span class="selector-tag">4</span> <span class="selector-tag">11</span><span class="selector-pseudo">:55</span><span class="selector-pseudo">:02</span> <span class="selector-tag">pay3</span> <span class="selector-tag">push</span><span class="selector-attr">[13039]</span>:    <span class="selector-tag">java</span><span class="selector-class">.lang</span><span class="selector-class">.Thread</span><span class="selector-class">.State</span>: <span class="selector-tag">RUNNABLE</span></span><br><span class="line"><span class="selector-tag">Mar</span>  <span class="selector-tag">4</span> <span class="selector-tag">11</span><span class="selector-pseudo">:55</span><span class="selector-pseudo">:02</span> <span class="selector-tag">pay3</span> <span class="selector-tag">push</span><span class="selector-attr">[13039]</span>: <span class="selector-id">#011at</span> <span class="selector-tag">sun</span><span class="selector-class">.nio</span><span class="selector-class">.ch</span><span class="selector-class">.EPollArrayWrapper</span><span class="selector-class">.epollWait</span>(Native Method)</span><br><span class="line"><span class="selector-tag">Mar</span>  <span class="selector-tag">4</span> <span class="selector-tag">11</span><span class="selector-pseudo">:55</span><span class="selector-pseudo">:02</span> <span class="selector-tag">pay3</span> <span class="selector-tag">push</span><span class="selector-attr">[13039]</span>: <span class="selector-id">#011at</span> <span class="selector-tag">sun</span><span class="selector-class">.nio</span><span class="selector-class">.ch</span><span class="selector-class">.EPollArrayWrapper</span><span class="selector-class">.poll</span>(EPollArrayWrapper.<span class="attribute">java</span>:<span class="number">269</span>)</span><br><span class="line"><span class="selector-tag">Mar</span>  <span class="selector-tag">4</span> <span class="selector-tag">11</span><span class="selector-pseudo">:55</span><span class="selector-pseudo">:02</span> <span class="selector-tag">pay3</span> <span class="selector-tag">push</span><span class="selector-attr">[13039]</span>: <span class="selector-id">#011at</span> <span class="selector-tag">sun</span><span class="selector-class">.nio</span><span class="selector-class">.ch</span><span class="selector-class">.EPollSelectorImpl</span><span class="selector-class">.doSelect</span>(EPollSelectorImpl.<span class="attribute">java</span>:<span class="number">93</span>)</span><br><span class="line"><span class="selector-tag">Mar</span>  <span class="selector-tag">4</span> <span class="selector-tag">11</span><span class="selector-pseudo">:55</span><span class="selector-pseudo">:02</span> <span class="selector-tag">pay3</span> <span class="selector-tag">push</span><span class="selector-attr">[13039]</span>: <span class="selector-id">#011at</span> <span class="selector-tag">sun</span><span class="selector-class">.nio</span><span class="selector-class">.ch</span><span class="selector-class">.SelectorImpl</span><span class="selector-class">.lockAndDoSelect</span>(SelectorImpl.<span class="attribute">java</span>:<span class="number">86</span>)</span><br><span class="line">Mar  4 11:55:02 pay3 push[13039]: #011- locked &lt;0x000000009c1495e0&gt; (a io.netty.channel.nio.SelectedSelectionKeySet)</span><br><span class="line">Mar  4 11:55:02 pay3 push[13039]: #011- locked &lt;0x000000009c1496d0&gt; (a java.util.Collections$UnmodifiableSet)</span><br><span class="line">Mar  4 11:55:02 pay3 push[13039]: #011- locked &lt;0x000000009c1495f8&gt; (a sun.nio.ch.EPollSelectorImpl)</span><br><span class="line"><span class="selector-tag">Mar</span>  <span class="selector-tag">4</span> <span class="selector-tag">11</span><span class="selector-pseudo">:55</span><span class="selector-pseudo">:02</span> <span class="selector-tag">pay3</span> <span class="selector-tag">push</span><span class="selector-attr">[13039]</span>: <span class="selector-id">#011at</span> <span class="selector-tag">sun</span><span class="selector-class">.nio</span><span class="selector-class">.ch</span><span class="selector-class">.SelectorImpl</span><span class="selector-class">.select</span>(SelectorImpl.<span class="attribute">java</span>:<span class="number">97</span>)</span><br><span class="line"><span class="selector-tag">Mar</span>  <span class="selector-tag">4</span> <span class="selector-tag">11</span><span class="selector-pseudo">:55</span><span class="selector-pseudo">:02</span> <span class="selector-tag">pay3</span> <span class="selector-tag">push</span><span class="selector-attr">[13039]</span>: <span class="selector-id">#011at</span> <span class="selector-tag">io</span><span class="selector-class">.netty</span><span class="selector-class">.channel</span><span class="selector-class">.nio</span><span class="selector-class">.SelectedSelectionKeySetSelector</span><span class="selector-class">.select</span>(SelectedSelectionKeySetSelector.<span class="attribute">java</span>:<span class="number">62</span>)</span><br><span class="line"><span class="selector-tag">Mar</span>  <span class="selector-tag">4</span> <span class="selector-tag">11</span><span class="selector-pseudo">:55</span><span class="selector-pseudo">:02</span> <span class="selector-tag">pay3</span> <span class="selector-tag">push</span><span class="selector-attr">[13039]</span>: <span class="selector-id">#011at</span> <span class="selector-tag">io</span><span class="selector-class">.netty</span><span class="selector-class">.channel</span><span class="selector-class">.nio</span><span class="selector-class">.NioEventLoop</span><span class="selector-class">.select</span>(NioEventLoop.<span class="attribute">java</span>:<span class="number">806</span>)</span><br><span class="line"><span class="selector-tag">Mar</span>  <span class="selector-tag">4</span> <span class="selector-tag">11</span><span class="selector-pseudo">:55</span><span class="selector-pseudo">:02</span> <span class="selector-tag">pay3</span> <span class="selector-tag">push</span><span class="selector-attr">[13039]</span>: <span class="selector-id">#011at</span> <span class="selector-tag">io</span><span class="selector-class">.netty</span><span class="selector-class">.channel</span><span class="selector-class">.nio</span><span class="selector-class">.NioEventLoop</span><span class="selector-class">.run</span>(NioEventLoop.<span class="attribute">java</span>:<span class="number">454</span>)</span><br><span class="line">Mar  4 11:55:02 pay3 push[13039]: #011at io.netty.util.concurrent.SingleThreadEventExecutor$5.run(SingleThreadEventExecutor.java:918)</span><br><span class="line">Mar  4 11:55:02 pay3 push[13039]: #011at io.netty.util.internal.ThreadExecutorMap$2.run(ThreadExecutorMap.java:74)</span><br><span class="line"><span class="selector-tag">Mar</span>  <span class="selector-tag">4</span> <span class="selector-tag">11</span><span class="selector-pseudo">:55</span><span class="selector-pseudo">:02</span> <span class="selector-tag">pay3</span> <span class="selector-tag">push</span><span class="selector-attr">[13039]</span>: <span class="selector-id">#011at</span> <span class="selector-tag">io</span><span class="selector-class">.netty</span><span class="selector-class">.util</span><span class="selector-class">.concurrent</span><span class="selector-class">.FastThreadLocalRunnable</span><span class="selector-class">.run</span>(FastThreadLocalRunnable.<span class="attribute">java</span>:<span class="number">30</span>)</span><br><span class="line"><span class="selector-tag">Mar</span>  <span class="selector-tag">4</span> <span class="selector-tag">11</span><span class="selector-pseudo">:55</span><span class="selector-pseudo">:02</span> <span class="selector-tag">pay3</span> <span class="selector-tag">push</span><span class="selector-attr">[13039]</span>: <span class="selector-id">#011at</span> <span class="selector-tag">java</span><span class="selector-class">.lang</span><span class="selector-class">.Thread</span><span class="selector-class">.run</span>(Thread.<span class="attribute">java</span>:<span class="number">748</span>)</span><br><span class="line"><span class="selector-tag">Mar</span>  <span class="selector-tag">4</span> <span class="selector-tag">11</span><span class="selector-pseudo">:55</span><span class="selector-pseudo">:02</span> <span class="selector-tag">pay3</span> <span class="selector-tag">push</span><span class="selector-attr">[13039]</span>: </span><br><span class="line">Mar  4 11:55:02 pay3 push[13039]: "nioEventLoopGroup-21-1" #8726 prio=10 os_prio=0 tid=0x00007f24f0024800 nid=0x5b0b runnable [0x00007f22ab838000]</span><br><span class="line"><span class="selector-tag">Mar</span>  <span class="selector-tag">4</span> <span class="selector-tag">11</span><span class="selector-pseudo">:55</span><span class="selector-pseudo">:02</span> <span class="selector-tag">pay3</span> <span class="selector-tag">push</span><span class="selector-attr">[13039]</span>:    <span class="selector-tag">java</span><span class="selector-class">.lang</span><span class="selector-class">.Thread</span><span class="selector-class">.State</span>: <span class="selector-tag">RUNNABLE</span></span><br><span class="line"><span class="selector-tag">Mar</span>  <span class="selector-tag">4</span> <span class="selector-tag">11</span><span class="selector-pseudo">:55</span><span class="selector-pseudo">:02</span> <span class="selector-tag">pay3</span> <span class="selector-tag">push</span><span class="selector-attr">[13039]</span>: <span class="selector-id">#011at</span> <span class="selector-tag">sun</span><span class="selector-class">.nio</span><span class="selector-class">.ch</span><span class="selector-class">.EPollArrayWrapper</span><span class="selector-class">.epollWait</span>(Native Method)</span><br><span class="line"><span class="selector-tag">Mar</span>  <span class="selector-tag">4</span> <span class="selector-tag">11</span><span class="selector-pseudo">:55</span><span class="selector-pseudo">:02</span> <span class="selector-tag">pay3</span> <span class="selector-tag">push</span><span class="selector-attr">[13039]</span>: <span class="selector-id">#011at</span> <span class="selector-tag">sun</span><span class="selector-class">.nio</span><span class="selector-class">.ch</span><span class="selector-class">.EPollArrayWrapper</span><span class="selector-class">.poll</span>(EPollArrayWrapper.<span class="attribute">java</span>:<span class="number">269</span>)</span><br><span class="line"><span class="selector-tag">Mar</span>  <span class="selector-tag">4</span> <span class="selector-tag">11</span><span class="selector-pseudo">:55</span><span class="selector-pseudo">:02</span> <span class="selector-tag">pay3</span> <span class="selector-tag">push</span><span class="selector-attr">[13039]</span>: <span class="selector-id">#011at</span> <span class="selector-tag">sun</span><span class="selector-class">.nio</span><span class="selector-class">.ch</span><span class="selector-class">.EPollSelectorImpl</span><span class="selector-class">.doSelect</span>(EPollSelectorImpl.<span class="attribute">java</span>:<span class="number">93</span>)</span><br><span class="line"><span class="selector-tag">Mar</span>  <span class="selector-tag">4</span> <span class="selector-tag">11</span><span class="selector-pseudo">:55</span><span class="selector-pseudo">:02</span> <span class="selector-tag">pay3</span> <span class="selector-tag">push</span><span class="selector-attr">[13039]</span>: <span class="selector-id">#011at</span> <span class="selector-tag">sun</span><span class="selector-class">.nio</span><span class="selector-class">.ch</span><span class="selector-class">.SelectorImpl</span><span class="selector-class">.lockAndDoSelect</span>(SelectorImpl.<span class="attribute">java</span>:<span class="number">86</span>)</span><br><span class="line">Mar  4 11:55:02 pay3 push[13039]: #011- locked &lt;0x000000009c16f878&gt; (a io.netty.channel.nio.SelectedSelectionKeySet)</span><br><span class="line">Mar  4 11:55:02 pay3 push[13039]: #011- locked &lt;0x000000009c16f968&gt; (a java.util.Collections$UnmodifiableSet)</span><br><span class="line">Mar  4 11:55:02 pay3 push[13039]: #011- locked &lt;0x000000009c16f890&gt; (a sun.nio.ch.EPollSelectorImpl)</span><br><span class="line"><span class="selector-tag">Mar</span>  <span class="selector-tag">4</span> <span class="selector-tag">11</span><span class="selector-pseudo">:55</span><span class="selector-pseudo">:02</span> <span class="selector-tag">pay3</span> <span class="selector-tag">push</span><span class="selector-attr">[13039]</span>: <span class="selector-id">#011at</span> <span class="selector-tag">sun</span><span class="selector-class">.nio</span><span class="selector-class">.ch</span><span class="selector-class">.SelectorImpl</span><span class="selector-class">.select</span>(SelectorImpl.<span class="attribute">java</span>:<span class="number">97</span>)</span><br><span class="line"><span class="selector-tag">Mar</span>  <span class="selector-tag">4</span> <span class="selector-tag">11</span><span class="selector-pseudo">:55</span><span class="selector-pseudo">:02</span> <span class="selector-tag">pay3</span> <span class="selector-tag">push</span><span class="selector-attr">[13039]</span>: <span class="selector-id">#011at</span> <span class="selector-tag">io</span><span class="selector-class">.netty</span><span class="selector-class">.channel</span><span class="selector-class">.nio</span><span class="selector-class">.SelectedSelectionKeySetSelector</span><span class="selector-class">.select</span>(SelectedSelectionKeySetSelector.<span class="attribute">java</span>:<span class="number">62</span>)</span><br><span class="line"><span class="selector-tag">Mar</span>  <span class="selector-tag">4</span> <span class="selector-tag">11</span><span class="selector-pseudo">:55</span><span class="selector-pseudo">:02</span> <span class="selector-tag">pay3</span> <span class="selector-tag">push</span><span class="selector-attr">[13039]</span>: <span class="selector-id">#011at</span> <span class="selector-tag">io</span><span class="selector-class">.netty</span><span class="selector-class">.channel</span><span class="selector-class">.nio</span><span class="selector-class">.NioEventLoop</span><span class="selector-class">.select</span>(NioEventLoop.<span class="attribute">java</span>:<span class="number">806</span>)</span><br><span class="line"><span class="selector-tag">Mar</span>  <span class="selector-tag">4</span> <span class="selector-tag">11</span><span class="selector-pseudo">:55</span><span class="selector-pseudo">:02</span> <span class="selector-tag">pay3</span> <span class="selector-tag">push</span><span class="selector-attr">[13039]</span>: <span class="selector-id">#011at</span> <span class="selector-tag">io</span><span class="selector-class">.netty</span><span class="selector-class">.channel</span><span class="selector-class">.nio</span><span class="selector-class">.NioEventLoop</span><span class="selector-class">.run</span>(NioEventLoop.<span class="attribute">java</span>:<span class="number">454</span>)</span><br><span class="line">Mar  4 11:55:02 pay3 push[13039]: #011at io.netty.util.concurrent.SingleThreadEventExecutor$5.run(SingleThreadEventExecutor.java:918)</span><br><span class="line">Mar  4 11:55:02 pay3 push[13039]: #011at io.netty.util.internal.ThreadExecutorMap$2.run(ThreadExecutorMap.java:74)</span><br><span class="line"><span class="selector-tag">Mar</span>  <span class="selector-tag">4</span> <span class="selector-tag">11</span><span class="selector-pseudo">:55</span><span class="selector-pseudo">:02</span> <span class="selector-tag">pay3</span> <span class="selector-tag">push</span><span class="selector-attr">[13039]</span>: <span class="selector-id">#011at</span> <span class="selector-tag">io</span><span class="selector-class">.netty</span><span class="selector-class">.util</span><span class="selector-class">.concurrent</span><span class="selector-class">.FastThreadLocalRunnable</span><span class="selector-class">.run</span>(FastThreadLocalRunnable.<span class="attribute">java</span>:<span class="number">30</span>)</span><br><span class="line"><span class="selector-tag">Mar</span>  <span class="selector-tag">4</span> <span class="selector-tag">11</span><span class="selector-pseudo">:55</span><span class="selector-pseudo">:02</span> <span class="selector-tag">pay3</span> <span class="selector-tag">push</span><span class="selector-attr">[13039]</span>: <span class="selector-id">#011at</span> <span class="selector-tag">java</span><span class="selector-class">.lang</span><span class="selector-class">.Thread</span><span class="selector-class">.run</span>(Thread.<span class="attribute">java</span>:<span class="number">748</span>)</span><br><span class="line"><span class="selector-tag">Mar</span>  <span class="selector-tag">4</span> <span class="selector-tag">11</span><span class="selector-pseudo">:55</span><span class="selector-pseudo">:02</span> <span class="selector-tag">pay3</span> <span class="selector-tag">push</span><span class="selector-attr">[13039]</span>: </span><br><span class="line">Mar  4 11:55:02 pay3 push[13039]: "nioEventLoopGroup-29-4" #7680 prio=10 os_prio=0 tid=0x00007f265c002000 nid=0x54bf runnable [0x00007f22abb3e000]</span><br><span class="line"><span class="selector-tag">Mar</span>  <span class="selector-tag">4</span> <span class="selector-tag">11</span><span class="selector-pseudo">:55</span><span class="selector-pseudo">:02</span> <span class="selector-tag">pay3</span> <span class="selector-tag">push</span><span class="selector-attr">[13039]</span>:    <span class="selector-tag">java</span><span class="selector-class">.lang</span><span class="selector-class">.Thread</span><span class="selector-class">.State</span>: <span class="selector-tag">RUNNABLE</span></span><br><span class="line"><span class="selector-tag">Mar</span>  <span class="selector-tag">4</span> <span class="selector-tag">11</span><span class="selector-pseudo">:55</span><span class="selector-pseudo">:02</span> <span class="selector-tag">pay3</span> <span class="selector-tag">push</span><span class="selector-attr">[13039]</span>: <span class="selector-id">#011at</span> <span class="selector-tag">sun</span><span class="selector-class">.nio</span><span class="selector-class">.ch</span><span class="selector-class">.EPollArrayWrapper</span><span class="selector-class">.epollWait</span>(Native Method)</span><br><span class="line"><span class="selector-tag">Mar</span>  <span class="selector-tag">4</span> <span class="selector-tag">11</span><span class="selector-pseudo">:55</span><span class="selector-pseudo">:02</span> <span class="selector-tag">pay3</span> <span class="selector-tag">push</span><span class="selector-attr">[13039]</span>: <span class="selector-id">#011at</span> <span class="selector-tag">sun</span><span class="selector-class">.nio</span><span class="selector-class">.ch</span><span class="selector-class">.EPollArrayWrapper</span><span class="selector-class">.poll</span>(EPollArrayWrapper.<span class="attribute">java</span>:<span class="number">269</span>)</span><br><span class="line"><span class="selector-tag">Mar</span>  <span class="selector-tag">4</span> <span class="selector-tag">11</span><span class="selector-pseudo">:55</span><span class="selector-pseudo">:02</span> <span class="selector-tag">pay3</span> <span class="selector-tag">push</span><span class="selector-attr">[13039]</span>: <span class="selector-id">#011at</span> <span class="selector-tag">sun</span><span class="selector-class">.nio</span><span class="selector-class">.ch</span><span class="selector-class">.EPollSelectorImpl</span><span class="selector-class">.doSelect</span>(EPollSelectorImpl.<span class="attribute">java</span>:<span class="number">93</span>)</span><br><span class="line"><span class="selector-tag">Mar</span>  <span class="selector-tag">4</span> <span class="selector-tag">11</span><span class="selector-pseudo">:55</span><span class="selector-pseudo">:02</span> <span class="selector-tag">pay3</span> <span class="selector-tag">push</span><span class="selector-attr">[13039]</span>: <span class="selector-id">#011at</span> <span class="selector-tag">sun</span><span class="selector-class">.nio</span><span class="selector-class">.ch</span><span class="selector-class">.SelectorImpl</span><span class="selector-class">.lockAndDoSelect</span>(SelectorImpl.<span class="attribute">java</span>:<span class="number">86</span>)</span><br><span class="line">Mar  4 11:55:02 pay3 push[13039]: #011- locked &lt;0x000000009c02eec8&gt; (a io.netty.channel.nio.SelectedSelectionKeySet)</span><br><span class="line">Mar  4 11:55:02 pay3 push[13039]: #011- locked &lt;0x000000009c02efb8&gt; (a java.util.Collections$UnmodifiableSet)</span><br><span class="line">Mar  4 11:55:02 pay3 push[13039]: #011- locked &lt;0x000000009c02eee0&gt; (a sun.nio.ch.EPollSelectorImpl)</span><br><span class="line"><span class="selector-tag">Mar</span>  <span class="selector-tag">4</span> <span class="selector-tag">11</span><span class="selector-pseudo">:55</span><span class="selector-pseudo">:02</span> <span class="selector-tag">pay3</span> <span class="selector-tag">push</span><span class="selector-attr">[13039]</span>: <span class="selector-id">#011at</span> <span class="selector-tag">sun</span><span class="selector-class">.nio</span><span class="selector-class">.ch</span><span class="selector-class">.SelectorImpl</span><span class="selector-class">.select</span>(SelectorImpl.<span class="attribute">java</span>:<span class="number">97</span>)</span><br><span class="line"><span class="selector-tag">Mar</span>  <span class="selector-tag">4</span> <span class="selector-tag">11</span><span class="selector-pseudo">:55</span><span class="selector-pseudo">:02</span> <span class="selector-tag">pay3</span> <span class="selector-tag">push</span><span class="selector-attr">[13039]</span>: <span class="selector-id">#011at</span> <span class="selector-tag">io</span><span class="selector-class">.netty</span><span class="selector-class">.channel</span><span class="selector-class">.nio</span><span class="selector-class">.SelectedSelectionKeySetSelector</span><span class="selector-class">.select</span>(SelectedSelectionKeySetSelector.<span class="attribute">java</span>:<span class="number">62</span>)</span><br><span class="line"><span class="selector-tag">Mar</span>  <span class="selector-tag">4</span> <span class="selector-tag">11</span><span class="selector-pseudo">:55</span><span class="selector-pseudo">:02</span> <span class="selector-tag">pay3</span> <span class="selector-tag">push</span><span class="selector-attr">[13039]</span>: <span class="selector-id">#011at</span> <span class="selector-tag">io</span><span class="selector-class">.netty</span><span class="selector-class">.channel</span><span class="selector-class">.nio</span><span class="selector-class">.NioEventLoop</span><span class="selector-class">.select</span>(NioEventLoop.<span class="attribute">java</span>:<span class="number">806</span>)</span><br><span class="line"><span class="selector-tag">Mar</span>  <span class="selector-tag">4</span> <span class="selector-tag">11</span><span class="selector-pseudo">:55</span><span class="selector-pseudo">:02</span> <span class="selector-tag">pay3</span> <span class="selector-tag">push</span><span class="selector-attr">[13039]</span>: <span class="selector-id">#011at</span> <span class="selector-tag">io</span><span class="selector-class">.netty</span><span class="selector-class">.channel</span><span class="selector-class">.nio</span><span class="selector-class">.NioEventLoop</span><span class="selector-class">.run</span>(NioEventLoop.<span class="attribute">java</span>:<span class="number">454</span>)</span><br><span class="line">Mar  4 11:55:02 pay3 push[13039]: #011at io.netty.util.concurrent.SingleThreadEventExecutor$5.run(SingleThreadEventExecutor.java:918)</span><br><span class="line">Mar  4 11:55:02 pay3 push[13039]: #011at io.netty.util.internal.ThreadExecutorMap$2.run(ThreadExecutorMap.java:74)</span><br><span class="line"><span class="selector-tag">Mar</span>  <span class="selector-tag">4</span> <span class="selector-tag">11</span><span class="selector-pseudo">:55</span><span class="selector-pseudo">:02</span> <span class="selector-tag">pay3</span> <span class="selector-tag">push</span><span class="selector-attr">[13039]</span>: <span class="selector-id">#011at</span> <span class="selector-tag">io</span><span class="selector-class">.netty</span><span class="selector-class">.util</span><span class="selector-class">.concurrent</span><span class="selector-class">.FastThreadLocalRunnable</span><span class="selector-class">.run</span>(FastThreadLocalRunnable.<span class="attribute">java</span>:<span class="number">30</span>)</span><br><span class="line"><span class="selector-tag">Mar</span>  <span class="selector-tag">4</span> <span class="selector-tag">11</span><span class="selector-pseudo">:55</span><span class="selector-pseudo">:02</span> <span class="selector-tag">pay3</span> <span class="selector-tag">push</span><span class="selector-attr">[13039]</span>: <span class="selector-id">#011at</span> <span class="selector-tag">java</span><span class="selector-class">.lang</span><span class="selector-class">.Thread</span><span class="selector-class">.run</span>(Thread.<span class="attribute">java</span>:<span class="number">748</span>)</span><br><span class="line"><span class="selector-tag">Mar</span>  <span class="selector-tag">4</span> <span class="selector-tag">11</span><span class="selector-pseudo">:55</span><span class="selector-pseudo">:02</span> <span class="selector-tag">pay3</span> <span class="selector-tag">push</span><span class="selector-attr">[13039]</span>: </span><br><span class="line">Mar  4 11:55:02 pay3 push[13039]: "nioEventLoopGroup-29-3" #7662 prio=10 os_prio=0 tid=0x00007f2650006800 nid=0x54a4 runnable [0x00007f22ac3cb000]</span><br><span class="line"><span class="selector-tag">Mar</span>  <span class="selector-tag">4</span> <span class="selector-tag">11</span><span class="selector-pseudo">:55</span><span class="selector-pseudo">:02</span> <span class="selector-tag">pay3</span> <span class="selector-tag">push</span><span class="selector-attr">[13039]</span>:    <span class="selector-tag">java</span><span class="selector-class">.lang</span><span class="selector-class">.Thread</span><span class="selector-class">.State</span>: <span class="selector-tag">RUNNABLE</span></span><br><span class="line"><span class="selector-tag">Mar</span>  <span class="selector-tag">4</span> <span class="selector-tag">11</span><span class="selector-pseudo">:55</span><span class="selector-pseudo">:02</span> <span class="selector-tag">pay3</span> <span class="selector-tag">push</span><span class="selector-attr">[13039]</span>: <span class="selector-id">#011at</span> <span class="selector-tag">sun</span><span class="selector-class">.nio</span><span class="selector-class">.ch</span><span class="selector-class">.EPollArrayWrapper</span><span class="selector-class">.epollWait</span>(Native Method)</span><br><span class="line"><span class="selector-tag">Mar</span>  <span class="selector-tag">4</span> <span class="selector-tag">11</span><span class="selector-pseudo">:55</span><span class="selector-pseudo">:02</span> <span class="selector-tag">pay3</span> <span class="selector-tag">push</span><span class="selector-attr">[13039]</span>: <span class="selector-id">#011at</span> <span class="selector-tag">sun</span><span class="selector-class">.nio</span><span class="selector-class">.ch</span><span class="selector-class">.EPollArrayWrapper</span><span class="selector-class">.poll</span>(EPollArrayWrapper.<span class="attribute">java</span>:<span class="number">269</span>)</span><br><span class="line"><span class="selector-tag">Mar</span>  <span class="selector-tag">4</span> <span class="selector-tag">11</span><span class="selector-pseudo">:55</span><span class="selector-pseudo">:02</span> <span class="selector-tag">pay3</span> <span class="selector-tag">push</span><span class="selector-attr">[13039]</span>: <span class="selector-id">#011at</span> <span class="selector-tag">sun</span><span class="selector-class">.nio</span><span class="selector-class">.ch</span><span class="selector-class">.EPollSelectorImpl</span><span class="selector-class">.doSelect</span>(EPollSelectorImpl.<span class="attribute">java</span>:<span class="number">93</span>)</span><br><span class="line"><span class="selector-tag">Mar</span>  <span class="selector-tag">4</span> <span class="selector-tag">11</span><span class="selector-pseudo">:55</span><span class="selector-pseudo">:02</span> <span class="selector-tag">pay3</span> <span class="selector-tag">push</span><span class="selector-attr">[13039]</span>: <span class="selector-id">#011at</span> <span class="selector-tag">sun</span><span class="selector-class">.nio</span><span class="selector-class">.ch</span><span class="selector-class">.SelectorImpl</span><span class="selector-class">.lockAndDoSelect</span>(SelectorImpl.<span class="attribute">java</span>:<span class="number">86</span>)</span><br><span class="line">Mar  4 11:55:02 pay3 push[13039]: #011- locked &lt;0x000000009c329300&gt; (a io.netty.channel.nio.SelectedSelectionKeySet)</span><br><span class="line">Mar  4 11:55:02 pay3 push[13039]: #011- locked &lt;0x000000009c3293f0&gt; (a java.util.Collections$UnmodifiableSet)</span><br><span class="line">Mar  4 11:55:02 pay3 push[13039]: #011- locked &lt;0x000000009c329318&gt; (a sun.nio.ch.EPollSelectorImpl)</span><br><span class="line"><span class="selector-tag">Mar</span>  <span class="selector-tag">4</span> <span class="selector-tag">11</span><span class="selector-pseudo">:55</span><span class="selector-pseudo">:02</span> <span class="selector-tag">pay3</span> <span class="selector-tag">push</span><span class="selector-attr">[13039]</span>: <span class="selector-id">#011at</span> <span class="selector-tag">sun</span><span class="selector-class">.nio</span><span class="selector-class">.ch</span><span class="selector-class">.SelectorImpl</span><span class="selector-class">.select</span>(SelectorImpl.<span class="attribute">java</span>:<span class="number">97</span>)</span><br><span class="line"><span class="selector-tag">Mar</span>  <span class="selector-tag">4</span> <span class="selector-tag">11</span><span class="selector-pseudo">:55</span><span class="selector-pseudo">:02</span> <span class="selector-tag">pay3</span> <span class="selector-tag">push</span><span class="selector-attr">[13039]</span>: <span class="selector-id">#011at</span> <span class="selector-tag">io</span><span class="selector-class">.netty</span><span class="selector-class">.channel</span><span class="selector-class">.nio</span><span class="selector-class">.SelectedSelectionKeySetSelector</span><span class="selector-class">.select</span>(SelectedSelectionKeySetSelector.<span class="attribute">java</span>:<span class="number">62</span>)</span><br><span class="line"><span class="selector-tag">Mar</span>  <span class="selector-tag">4</span> <span class="selector-tag">11</span><span class="selector-pseudo">:55</span><span class="selector-pseudo">:02</span> <span class="selector-tag">pay3</span> <span class="selector-tag">push</span><span class="selector-attr">[13039]</span>: <span class="selector-id">#011at</span> <span class="selector-tag">io</span><span class="selector-class">.netty</span><span class="selector-class">.channel</span><span class="selector-class">.nio</span><span class="selector-class">.NioEventLoop</span><span class="selector-class">.select</span>(NioEventLoop.<span class="attribute">java</span>:<span class="number">806</span>)</span><br><span class="line"><span class="selector-tag">Mar</span>  <span class="selector-tag">4</span> <span class="selector-tag">11</span><span class="selector-pseudo">:55</span><span class="selector-pseudo">:02</span> <span class="selector-tag">pay3</span> <span class="selector-tag">push</span><span class="selector-attr">[13039]</span>: <span class="selector-id">#011at</span> <span class="selector-tag">io</span><span class="selector-class">.netty</span><span class="selector-class">.channel</span><span class="selector-class">.nio</span><span class="selector-class">.NioEventLoop</span><span class="selector-class">.run</span>(NioEventLoop.<span class="attribute">java</span>:<span class="number">454</span>)</span><br><span class="line">Mar  4 11:55:02 pay3 push[13039]: #011at io.netty.util.concurrent.SingleThreadEventExecutor$5.run(SingleThreadEventExecutor.java:918)</span><br><span class="line">Mar  4 11:55:02 pay3 push[13039]: #011at io.netty.util.internal.ThreadExecutorMap$2.run(ThreadExecutorMap.java:74)</span><br><span class="line"><span class="selector-tag">Mar</span>  <span class="selector-tag">4</span> <span class="selector-tag">11</span><span class="selector-pseudo">:55</span><span class="selector-pseudo">:02</span> <span class="selector-tag">pay3</span> <span class="selector-tag">push</span><span class="selector-attr">[13039]</span>: <span class="selector-id">#011at</span> <span class="selector-tag">io</span><span class="selector-class">.netty</span><span class="selector-class">.util</span><span class="selector-class">.concurrent</span><span class="selector-class">.FastThreadLocalRunnable</span><span class="selector-class">.run</span>(FastThreadLocalRunnable.<span class="attribute">java</span>:<span class="number">30</span>)</span><br><span class="line"><span class="selector-tag">Mar</span>  <span class="selector-tag">4</span> <span class="selector-tag">11</span><span class="selector-pseudo">:55</span><span class="selector-pseudo">:02</span> <span class="selector-tag">pay3</span> <span class="selector-tag">push</span><span class="selector-attr">[13039]</span>: <span class="selector-id">#011at</span> <span class="selector-tag">java</span><span class="selector-class">.lang</span><span class="selector-class">.Thread</span><span class="selector-class">.run</span>(Thread.<span class="attribute">java</span>:<span class="number">748</span>)</span><br><span class="line"><span class="selector-tag">Mar</span>  <span class="selector-tag">4</span> <span class="selector-tag">11</span><span class="selector-pseudo">:55</span><span class="selector-pseudo">:02</span> <span class="selector-tag">pay3</span> <span class="selector-tag">push</span><span class="selector-attr">[13039]</span>: </span><br><span class="line">Mar  4 11:55:02 pay3 push[13039]: "nioEventLoopGroup-29-2" #7661 prio=10 os_prio=0 tid=0x00007f2654058800 nid=0x54a3 runnable [0x00007f22b8af5000]</span><br><span class="line"><span class="selector-tag">Mar</span>  <span class="selector-tag">4</span> <span class="selector-tag">11</span><span class="selector-pseudo">:55</span><span class="selector-pseudo">:02</span> <span class="selector-tag">pay3</span> <span class="selector-tag">push</span><span class="selector-attr">[13039]</span>:    <span class="selector-tag">java</span><span class="selector-class">.lang</span><span class="selector-class">.Thread</span><span class="selector-class">.State</span>: <span class="selector-tag">RUNNABLE</span></span><br><span class="line"><span class="selector-tag">Mar</span>  <span class="selector-tag">4</span> <span class="selector-tag">11</span><span class="selector-pseudo">:55</span><span class="selector-pseudo">:02</span> <span class="selector-tag">pay3</span> <span class="selector-tag">push</span><span class="selector-attr">[13039]</span>: <span class="selector-id">#011at</span> <span class="selector-tag">sun</span><span class="selector-class">.nio</span><span class="selector-class">.ch</span><span class="selector-class">.EPollArrayWrapper</span><span class="selector-class">.epollWait</span>(Native Method)</span><br><span class="line"><span class="selector-tag">Mar</span>  <span class="selector-tag">4</span> <span class="selector-tag">11</span><span class="selector-pseudo">:55</span><span class="selector-pseudo">:02</span> <span class="selector-tag">pay3</span> <span class="selector-tag">push</span><span class="selector-attr">[13039]</span>: <span class="selector-id">#011at</span> <span class="selector-tag">sun</span><span class="selector-class">.nio</span><span class="selector-class">.ch</span><span class="selector-class">.EPollArrayWrapper</span><span class="selector-class">.poll</span>(EPollArrayWrapper.<span class="attribute">java</span>:<span class="number">269</span>)</span><br><span class="line"><span class="selector-tag">Mar</span>  <span class="selector-tag">4</span> <span class="selector-tag">11</span><span class="selector-pseudo">:55</span><span class="selector-pseudo">:02</span> <span class="selector-tag">pay3</span> <span class="selector-tag">push</span><span class="selector-attr">[13039]</span>: <span class="selector-id">#011at</span> <span class="selector-tag">sun</span><span class="selector-class">.nio</span><span class="selector-class">.ch</span><span class="selector-class">.EPollSelectorImpl</span><span class="selector-class">.doSelect</span>(EPollSelectorImpl.<span class="attribute">java</span>:<span class="number">93</span>)</span><br><span class="line"><span class="selector-tag">Mar</span>  <span class="selector-tag">4</span> <span class="selector-tag">11</span><span class="selector-pseudo">:55</span><span class="selector-pseudo">:02</span> <span class="selector-tag">pay3</span> <span class="selector-tag">push</span><span class="selector-attr">[13039]</span>: <span class="selector-id">#011at</span> <span class="selector-tag">sun</span><span class="selector-class">.nio</span><span class="selector-class">.ch</span><span class="selector-class">.SelectorImpl</span><span class="selector-class">.lockAndDoSelect</span>(SelectorImpl.<span class="attribute">java</span>:<span class="number">86</span>)</span><br><span class="line">Mar  4 11:55:02 pay3 push[13039]: #011- locked &lt;0x000000009c011ba0&gt; (a io.netty.channel.nio.SelectedSelectionKeySet)</span><br><span class="line">Mar  4 11:55:02 pay3 push[13039]: #011- locked &lt;0x000000009c011c90&gt; (a java.util.Collections$UnmodifiableSet)</span><br><span class="line">Mar  4 11:55:02 pay3 push[13039]: #011- locked &lt;0x000000009c011bb8&gt; (a sun.nio.ch.EPollSelectorImpl)</span><br><span class="line"><span class="selector-tag">Mar</span>  <span class="selector-tag">4</span> <span class="selector-tag">11</span><span class="selector-pseudo">:55</span><span class="selector-pseudo">:02</span> <span class="selector-tag">pay3</span> <span class="selector-tag">push</span><span class="selector-attr">[13039]</span>: <span class="selector-id">#011at</span> <span class="selector-tag">sun</span><span class="selector-class">.nio</span><span class="selector-class">.ch</span><span class="selector-class">.SelectorImpl</span><span class="selector-class">.select</span>(SelectorImpl.<span class="attribute">java</span>:<span class="number">97</span>)</span><br><span class="line"><span class="selector-tag">Mar</span>  <span class="selector-tag">4</span> <span class="selector-tag">11</span><span class="selector-pseudo">:55</span><span class="selector-pseudo">:02</span> <span class="selector-tag">pay3</span> <span class="selector-tag">push</span><span class="selector-attr">[13039]</span>: <span class="selector-id">#011at</span> <span class="selector-tag">io</span><span class="selector-class">.netty</span><span class="selector-class">.channel</span><span class="selector-class">.nio</span><span class="selector-class">.SelectedSelectionKeySetSelector</span><span class="selector-class">.select</span>(SelectedSelectionKeySetSelector.<span class="attribute">java</span>:<span class="number">62</span>)</span><br><span class="line"><span class="selector-tag">Mar</span>  <span class="selector-tag">4</span> <span class="selector-tag">11</span><span class="selector-pseudo">:55</span><span class="selector-pseudo">:02</span> <span class="selector-tag">pay3</span> <span class="selector-tag">push</span><span class="selector-attr">[13039]</span>: <span class="selector-id">#011at</span> <span class="selector-tag">io</span><span class="selector-class">.netty</span><span class="selector-class">.channel</span><span class="selector-class">.nio</span><span class="selector-class">.NioEventLoop</span><span class="selector-class">.select</span>(NioEventLoop.<span class="attribute">java</span>:<span class="number">806</span>)</span><br><span class="line"><span class="selector-tag">Mar</span>  <span class="selector-tag">4</span> <span class="selector-tag">11</span><span class="selector-pseudo">:55</span><span class="selector-pseudo">:02</span> <span class="selector-tag">pay3</span> <span class="selector-tag">push</span><span class="selector-attr">[13039]</span>: <span class="selector-id">#011at</span> <span class="selector-tag">io</span><span class="selector-class">.netty</span><span class="selector-class">.channel</span><span class="selector-class">.nio</span><span class="selector-class">.NioEventLoop</span><span class="selector-class">.run</span>(NioEventLoop.<span class="attribute">java</span>:<span class="number">454</span>)</span><br><span class="line">Mar  4 11:55:02 pay3 push[13039]: #011at io.netty.util.concurrent.SingleThreadEventExecutor$5.run(SingleThreadEventExecutor.java:918)</span><br><span class="line">Mar  4 11:55:02 pay3 push[13039]: #011at io.netty.util.internal.ThreadExecutorMap$2.run(ThreadExecutorMap.java:74)</span><br><span class="line"><span class="selector-tag">Mar</span>  <span class="selector-tag">4</span> <span class="selector-tag">11</span><span class="selector-pseudo">:55</span><span class="selector-pseudo">:02</span> <span class="selector-tag">pay3</span> <span class="selector-tag">push</span><span class="selector-attr">[13039]</span>: <span class="selector-id">#011at</span> <span class="selector-tag">io</span><span class="selector-class">.netty</span><span class="selector-class">.util</span><span class="selector-class">.concurrent</span><span class="selector-class">.FastThreadLocalRunnable</span><span class="selector-class">.run</span>(FastThreadLocalRunnable.<span class="attribute">java</span>:<span class="number">30</span>)</span><br><span class="line"><span class="selector-tag">Mar</span>  <span class="selector-tag">4</span> <span class="selector-tag">11</span><span class="selector-pseudo">:55</span><span class="selector-pseudo">:02</span> <span class="selector-tag">pay3</span> <span class="selector-tag">push</span><span class="selector-attr">[13039]</span>: <span class="selector-id">#011at</span> <span class="selector-tag">java</span><span class="selector-class">.lang</span><span class="selector-class">.Thread</span><span class="selector-class">.run</span>(Thread.<span class="attribute">java</span>:<span class="number">748</span>)</span><br></pre></td></tr></table></figure>
<p>最终发现每天定时任务有重新初始化apns通道，但是初始化的时候没关闭原先apns客户端，这才最终导致线程增长不释放问题。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// spring容器初始化成功调用 和 每天晚上凌晨2点调用</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">fillDeliveryStrategyMapper</span><span class="params">(ApplicationContext context)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> MessageService messageService = context.getBean(MessageService.class);</span><br><span class="line">  <span class="keyword">final</span> AsyncUserService asyncUserService = context.getBean(AsyncUserService.class);</span><br><span class="line">  <span class="keyword">final</span> RocketMQQueueService rocketMQQueueService = context.getBean(RocketMQQueueService.class);</span><br><span class="line">  RuntimeService runtimeService = context.getBean(RuntimeService.class);</span><br><span class="line">  <span class="keyword">final</span> DeliveryStrategyMapper deliveryStrategyMapper = context</span><br><span class="line">    .getBean(DeliveryStrategyMapper.class);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">final</span> Builder&lt;String, Delivery&lt;NotificationPackage&gt;&gt; builder = ImmutableMap.builder();</span><br><span class="line">  <span class="keyword">final</span> List&lt;String&gt; registeredAppNames = CommonHelper.getRegisteredApps();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">final</span> String appName : registeredAppNames) &#123;</span><br><span class="line">    <span class="keyword">final</span> PushyRegistry registry = CommonHelper.getPushyRegistry(appName);</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">null</span> != registry) &#123;</span><br><span class="line">      builder.put(appName + Constants.Channel.PUSHY,</span><br><span class="line">                  <span class="keyword">new</span> ImmediateDelivery(</span><br><span class="line">                    <span class="keyword">new</span> PushyNotificationService(runtimeService,registry, messageService, rocketMQQueueService,</span><br><span class="line">                                                 asyncUserService, <span class="keyword">false</span>)));</span><br><span class="line"></span><br><span class="line">      <span class="comment">//iso Sandbox</span></span><br><span class="line">      builder.put(appName + Constants.Channel.IOS_SANDBOX,</span><br><span class="line">                  <span class="keyword">new</span> ImmediateDelivery(</span><br><span class="line">                    <span class="keyword">new</span> PushyNotificationService(runtimeService,registry, messageService, rocketMQQueueService,</span><br><span class="line">                                                 asyncUserService, <span class="keyword">true</span>)));</span><br><span class="line"></span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">final</span> String secret = CommonHelper.getAndroidPushProviderProperty(appName, CommonHelper.PUSH_MI_REGISTRY_SECRET);</span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isNotEmpty(secret)) &#123;</span><br><span class="line">      builder.put(appName + Constants.Channel.MI,</span><br><span class="line">                  <span class="keyword">new</span> BufferedDelivery(</span><br><span class="line">                    <span class="keyword">new</span> MiNotificationService(secret, messageService, asyncUserService), <span class="number">1000</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> String appKey = CommonHelper.getAndroidPushProviderProperty(appName, CommonHelper.PUSH_UPUSH_REGISTRY_APPKEY);</span><br><span class="line">    <span class="keyword">final</span> String uPushSecret = CommonHelper.getAndroidPushProviderProperty(appName, CommonHelper.PUSH_UPUSH_REGISTRY_SECRET);</span><br><span class="line">    <span class="keyword">if</span> (StringUtil.isNotEmpty(appKey, uPushSecret)) &#123;</span><br><span class="line">      builder.put(appName + Constants.Channel.UPUSH,</span><br><span class="line">                  <span class="keyword">new</span> BufferedDelivery(</span><br><span class="line">                    <span class="keyword">new</span> UPushNotificationService(appKey, uPushSecret, messageService, asyncUserService),</span><br><span class="line">                    <span class="number">500</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> String getuiAppId = CommonHelper.getAndroidPushProviderProperty(appName, CommonHelper.PUSH_GETUI_REGISTRY_APP_ID_MATCHER);</span><br><span class="line">    <span class="keyword">final</span> String getuiAppKey = CommonHelper.getAndroidPushProviderProperty(appName, CommonHelper.PUSH_GETUI_REGISTRY_APP_KEY_MATCHER);</span><br><span class="line">    <span class="keyword">final</span> String getuiMasterSecret = CommonHelper.getAndroidPushProviderProperty(appName, CommonHelper.PUSH_GETUI_REGISTRY_MASTER_SECRET_MATCHER);</span><br><span class="line">    <span class="keyword">if</span> (StringUtil.isNotEmpty(getuiAppId, getuiAppKey, getuiMasterSecret)) &#123;</span><br><span class="line">      builder.put(appName + Constants.Channel.GETUI,</span><br><span class="line">                  <span class="keyword">new</span> BufferedDelivery(<span class="keyword">new</span> GetuiNotificationService(getuiAppId, getuiAppKey, getuiMasterSecret, messageService, asyncUserService, appName), GetuiChannel.GETUI_MAX_BATCH_SIZE));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 初始化所有的推送通道，这里没有关闭以前的创建的客户端</span></span><br><span class="line">  deliveryStrategyMapper.setMapper(builder.build());</span><br><span class="line"></span><br><span class="line">  log.info(<span class="string">"push notification delivery strategies: &#123;&#125;"</span>,</span><br><span class="line">           ReflectionToStringBuilder.toString(deliveryStrategyMapper));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="lxd容器线程不能创建问题"><a href="#lxd容器线程不能创建问题" class="headerlink" title="lxd容器线程不能创建问题"></a>lxd容器线程不能创建问题</h4><p>由于线上某一台服务器经常出现线程数创建到470的时候，就直接报oom问题，然后触发jsw守护线程重启现象。刚开始我们也调整了lxd的线程数限制调整到4000，但是发现还是一直报错，最终调整容器的UserTasksMax参数。<a href="http://manpages.ubuntu.com/manpages/xenial/man5/logind.conf.5.html" target="_blank" rel="noopener">ubuntu文档</a></p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">Mar</span> <span class="selector-tag">11</span> <span class="selector-tag">17</span><span class="selector-pseudo">:33</span><span class="selector-pseudo">:04</span> <span class="selector-tag">pay3</span> <span class="selector-tag">push</span><span class="selector-attr">[16255]</span>: <span class="selector-tag">java</span><span class="selector-class">.lang</span><span class="selector-class">.OutOfMemoryError</span>: <span class="selector-tag">unable</span> <span class="selector-tag">to</span> <span class="selector-tag">create</span> <span class="selector-tag">new</span> <span class="selector-tag">native</span> <span class="selector-tag">thread</span></span><br><span class="line"><span class="selector-tag">Mar</span> <span class="selector-tag">11</span> <span class="selector-tag">17</span><span class="selector-pseudo">:33</span><span class="selector-pseudo">:04</span> <span class="selector-tag">pay3</span> <span class="selector-tag">push</span><span class="selector-attr">[16255]</span>: <span class="selector-tag">The</span> <span class="selector-tag">JVM</span> <span class="selector-tag">has</span> <span class="selector-tag">run</span> <span class="selector-tag">out</span> <span class="selector-tag">of</span> <span class="selector-tag">memory</span>.  <span class="selector-tag">Restarting</span> <span class="selector-tag">JVM</span>.</span><br><span class="line"><span class="selector-tag">Mar</span> <span class="selector-tag">11</span> <span class="selector-tag">17</span><span class="selector-pseudo">:33</span><span class="selector-pseudo">:04</span> <span class="selector-tag">pay3</span> <span class="selector-tag">push</span><span class="selector-attr">[16255]</span>: <span class="selector-id">#011at</span> <span class="selector-tag">java</span><span class="selector-class">.lang</span><span class="selector-class">.Thread</span><span class="selector-class">.start0</span>(Native Method) <span class="selector-attr">[na:1.8.0_242]</span></span><br><span class="line"><span class="selector-tag">Mar</span> <span class="selector-tag">11</span> <span class="selector-tag">17</span><span class="selector-pseudo">:33</span><span class="selector-pseudo">:04</span> <span class="selector-tag">pay3</span> <span class="selector-tag">push</span><span class="selector-attr">[16255]</span>: <span class="selector-id">#011at</span> <span class="selector-tag">java</span><span class="selector-class">.lang</span><span class="selector-class">.Thread</span><span class="selector-class">.start</span>(Thread.<span class="attribute">java</span>:<span class="number">717</span>) <span class="selector-attr">[na:1.8.0_242]</span></span><br><span class="line"><span class="selector-tag">Mar</span> <span class="selector-tag">11</span> <span class="selector-tag">17</span><span class="selector-pseudo">:33</span><span class="selector-pseudo">:04</span> <span class="selector-tag">pay3</span> <span class="selector-tag">push</span><span class="selector-attr">[16255]</span>: <span class="selector-id">#011at</span> <span class="selector-tag">java</span><span class="selector-class">.util</span><span class="selector-class">.concurrent</span><span class="selector-class">.ThreadPoolExecutor</span><span class="selector-class">.addWorker</span>(ThreadPoolExecutor.<span class="attribute">java</span>:<span class="number">957</span>) ~<span class="selector-attr">[na:1.8.0_242]</span></span><br><span class="line"><span class="selector-tag">Mar</span> <span class="selector-tag">11</span> <span class="selector-tag">17</span><span class="selector-pseudo">:33</span><span class="selector-pseudo">:04</span> <span class="selector-tag">pay3</span> <span class="selector-tag">push</span><span class="selector-attr">[16255]</span>: <span class="selector-id">#011at</span> <span class="selector-tag">java</span><span class="selector-class">.util</span><span class="selector-class">.concurrent</span><span class="selector-class">.ThreadPoolExecutor</span><span class="selector-class">.execute</span>(ThreadPoolExecutor.<span class="attribute">java</span>:<span class="number">1378</span>) ~<span class="selector-attr">[na:1.8.0_242]</span></span><br><span class="line"><span class="selector-tag">Mar</span> <span class="selector-tag">11</span> <span class="selector-tag">17</span><span class="selector-pseudo">:33</span><span class="selector-pseudo">:04</span> <span class="selector-tag">pay3</span> <span class="selector-tag">push</span><span class="selector-attr">[16255]</span>: <span class="selector-id">#011at</span> <span class="selector-tag">org</span><span class="selector-class">.apache</span><span class="selector-class">.tomcat</span><span class="selector-class">.util</span><span class="selector-class">.threads</span><span class="selector-class">.ThreadPoolExecutor</span><span class="selector-class">.execute</span>(ThreadPoolExecutor.<span class="attribute">java</span>:<span class="number">166</span>) ~<span class="selector-attr">[tomcat-coyote.jar:7.0.91]</span></span><br><span class="line"><span class="selector-tag">Mar</span> <span class="selector-tag">11</span> <span class="selector-tag">17</span><span class="selector-pseudo">:33</span><span class="selector-pseudo">:04</span> <span class="selector-tag">pay3</span> <span class="selector-tag">push</span><span class="selector-attr">[16255]</span>: <span class="selector-id">#011at</span> <span class="selector-tag">org</span><span class="selector-class">.apache</span><span class="selector-class">.tomcat</span><span class="selector-class">.util</span><span class="selector-class">.threads</span><span class="selector-class">.ThreadPoolExecutor</span><span class="selector-class">.execute</span>(ThreadPoolExecutor.<span class="attribute">java</span>:<span class="number">146</span>) ~<span class="selector-attr">[tomcat-coyote.jar:7.0.91]</span></span><br><span class="line"><span class="selector-tag">Mar</span> <span class="selector-tag">11</span> <span class="selector-tag">17</span><span class="selector-pseudo">:33</span><span class="selector-pseudo">:04</span> <span class="selector-tag">pay3</span> <span class="selector-tag">push</span><span class="selector-attr">[16255]</span>: <span class="selector-id">#011at</span> <span class="selector-tag">org</span><span class="selector-class">.apache</span><span class="selector-class">.tomcat</span><span class="selector-class">.util</span><span class="selector-class">.net</span><span class="selector-class">.NioEndpoint</span><span class="selector-class">.processSocket</span>(NioEndpoint.<span class="attribute">java</span>:<span class="number">761</span>) ~<span class="selector-attr">[tomcat-coyote.jar:7.0.91]</span></span><br><span class="line">Mar 11 17:33:04 pay3 push[16255]: #011at org.apache.tomcat.util.net.NioEndpoint$Poller.processKey(NioEndpoint.java:1304) ~[tomcat-coyote.jar:7.0.91]</span><br><span class="line">Mar 11 17:33:04 pay3 push[16255]: #011at org.apache.tomcat.util.net.NioEndpoint$Poller.run(NioEndpoint.java:1260) ~[tomcat-coyote.jar:7.0.91]</span><br><span class="line"><span class="selector-tag">Mar</span> <span class="selector-tag">11</span> <span class="selector-tag">17</span><span class="selector-pseudo">:33</span><span class="selector-pseudo">:04</span> <span class="selector-tag">pay3</span> <span class="selector-tag">push</span><span class="selector-attr">[16255]</span>: <span class="selector-id">#011at</span> <span class="selector-tag">java</span><span class="selector-class">.lang</span><span class="selector-class">.Thread</span><span class="selector-class">.run</span>(Thread.<span class="attribute">java</span>:<span class="number">748</span>) <span class="selector-attr">[na:1.8.0_242]</span></span><br></pre></td></tr></table></figure>
<p><strong>解决点：</strong></p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">UserTasksMax=</span><br><span class="line"><span class="selector-tag">Sets</span> <span class="selector-tag">the</span> <span class="selector-tag">maximum</span> <span class="selector-tag">number</span> <span class="selector-tag">of</span> <span class="selector-tag">OS</span> <span class="selector-tag">tasks</span> <span class="selector-tag">each</span> <span class="selector-tag">user</span> <span class="selector-tag">may</span> <span class="selector-tag">run</span> <span class="selector-tag">concurrently</span>. <span class="selector-tag">This</span> <span class="selector-tag">controls</span> <span class="selector-tag">the</span></span><br><span class="line">TasksMax= setting of the per-user slice unit, see systemd.resource-control(5) for</span><br><span class="line"><span class="selector-tag">details</span>. <span class="selector-tag">Defaults</span> <span class="selector-tag">to</span> <span class="selector-tag">12288</span> (<span class="number">12</span>K).</span><br></pre></td></tr></table></figure>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>分析这次堆外内存虽然最终定位到问题，总结下出现的问题和原因：</p>
<ol>
<li>由于之前的消息队列用kafka，后来切换到rocketmq就出现内存堆外内存增长问题，是因为kafka是每个分区分配一个线程去消费处理，但是rocketmq是多线程消费，每个topic默认是16个queue，是异步拉取消费，在加上apns内部用了内存队列来堆积消息，这就导致了内存暴增，最终导致fullgc问题；</li>
<li>threadlocal内存泄漏问题；</li>
<li>线程泄漏没有销毁问题；</li>
</ol>

      
    </div>
    
    
    

    

    
      <div>
        <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
  <div>写作是一个学习的过程,感谢你的赞助！</div>
  <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
    <span>Donate</span>
  </button>
  <div id="QR" style="display: none;">

    
      <div id="wechat" style="display: inline-block">
        <img id="wechat_qr" src="/images/wechatpay.png" alt="J~杰 WeChat Pay"/>
        <p>WeChat Pay</p>
      </div>
    

    
      <div id="alipay" style="display: inline-block">
        <img id="alipay_qr" src="/images/alipay.jpg" alt="J~杰 Alipay"/>
        <p>Alipay</p>
      </div>
    

    

  </div>
</div>

      </div>
    

    

    <div>
      
        <div>
    
        <div style="text-align:center;color: #ccc;font-size:14px;">-------------人生就一条路，走一步有一步的景观-------------</div>
    
</div>
      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/线上问题/" rel="tag"> <i class="fa fa-tag"></i> 线上问题</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/09/01/Spring源码构建环境搭建/" rel="next" title="Spring源码构建环境搭建">
                <i class="fa fa-chevron-left"></i> Spring源码构建环境搭建
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">J~杰</p>
              <p class="site-description motion-element" itemprop="description">人生就一条路，走一步有一步的景观</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives">
              
                  <span class="site-state-item-count">39</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">17</span>
                  <span class="site-state-item-name">categories</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">32</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#问题描述"><span class="nav-number">1.</span> <span class="nav-text">问题描述</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#问题排查"><span class="nav-number">2.</span> <span class="nav-text">问题排查</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#运维平台监控"><span class="nav-number">2.1.</span> <span class="nav-text">运维平台监控</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#NMT监控"><span class="nav-number">2.2.</span> <span class="nav-text">NMT监控</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#pmap查看内存分配情况"><span class="nav-number">2.3.</span> <span class="nav-text">pmap查看内存分配情况</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#操作系统工具分析"><span class="nav-number">2.4.</span> <span class="nav-text">操作系统工具分析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#内存堆栈分析"><span class="nav-number">2.5.</span> <span class="nav-text">内存堆栈分析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#问题分析"><span class="nav-number">2.6.</span> <span class="nav-text">问题分析</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#pushy消息内存堆积"><span class="nav-number">2.6.1.</span> <span class="nav-text">pushy消息内存堆积</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#threadlocal内存泄漏"><span class="nav-number">2.6.2.</span> <span class="nav-text">threadlocal内存泄漏</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#线程泄漏问题"><span class="nav-number">2.6.3.</span> <span class="nav-text">线程泄漏问题</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#lxd容器线程不能创建问题"><span class="nav-number">2.6.4.</span> <span class="nav-text">lxd容器线程不能创建问题</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#总结"><span class="nav-number">3.</span> <span class="nav-text">总结</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">J~杰</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.4</div>



<a href="http://www.miitbeian.gov.cn/">浙ICP备19013166号</a>

        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      <i class="fa fa-user"></i> 访问人数
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      人
    </span>
  

  
    <span class="site-pv">
      <i class="fa fa-eye"></i> 总访问量
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      次
    </span>
  
</div>








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  



<script src="/live2dw/lib/L2Dwidget.min.js?0c58a1486de42ac6cc1c59c7d98ae887"></script><script>L2Dwidget.init({"model":"wanko","bottom":-30,"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/"});</script></body>
</html>
<script type="text/javascript" src="/js/src/love.js"></script>