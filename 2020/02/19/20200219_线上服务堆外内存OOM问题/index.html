<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">


  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2" rel="stylesheet">







<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="线上问题," />





  <link rel="alternate" href="/atom.xml" title="J~杰's Blog" type="application/atom+xml" />






<meta name="description" content="1. 问题描述最近我们生产上的消息推送服务不断的爆出内存增长过大导致操作系统kill该进程，并且随着业务量的增长出现的频次越来越高，由去年12月底的半个月出现一次，到现在的一天出现一次。 该服务的业务逻辑就是消息推送，业务方推送消息，服务方通过rocketmq做削峰处理，其中主要通道是个推和apns（使用pushy框架）通道，业务方的全局推送大概在5000w用户左右，每全局推送一次，内存就会增长几">
<meta name="keywords" content="线上问题">
<meta property="og:type" content="article">
<meta property="og:title" content="线上服务堆外内存OOM问题">
<meta property="og:url" content="blog.ppjys.cn/2020/02/19/20200219_线上服务堆外内存OOM问题/index.html">
<meta property="og:site_name" content="J~杰&#39;s Blog">
<meta property="og:description" content="1. 问题描述最近我们生产上的消息推送服务不断的爆出内存增长过大导致操作系统kill该进程，并且随着业务量的增长出现的频次越来越高，由去年12月底的半个月出现一次，到现在的一天出现一次。 该服务的业务逻辑就是消息推送，业务方推送消息，服务方通过rocketmq做削峰处理，其中主要通道是个推和apns（使用pushy框架）通道，业务方的全局推送大概在5000w用户左右，每全局推送一次，内存就会增长几">
<meta property="og:locale" content="default">
<meta property="og:image" content="blog.ppjys.cn/2020/02/19/20200219_线上服务堆外内存OOM问题/images/oom1.png">
<meta property="og:image" content="blog.ppjys.cn/2020/02/19/20200219_线上服务堆外内存OOM问题/images/oom4.png">
<meta property="og:image" content="blog.ppjys.cn/2020/02/19/20200219_线上服务堆外内存OOM问题/images/oom2.png">
<meta property="og:image" content="blog.ppjys.cn/2020/02/19/20200219_线上服务堆外内存OOM问题/images/oom3.png">
<meta property="og:updated_time" content="2020-02-20T06:11:58.872Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="线上服务堆外内存OOM问题">
<meta name="twitter:description" content="1. 问题描述最近我们生产上的消息推送服务不断的爆出内存增长过大导致操作系统kill该进程，并且随着业务量的增长出现的频次越来越高，由去年12月底的半个月出现一次，到现在的一天出现一次。 该服务的业务逻辑就是消息推送，业务方推送消息，服务方通过rocketmq做削峰处理，其中主要通道是个推和apns（使用pushy框架）通道，业务方的全局推送大概在5000w用户左右，每全局推送一次，内存就会增长几">
<meta name="twitter:image" content="blog.ppjys.cn/2020/02/19/20200219_线上服务堆外内存OOM问题/images/oom1.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="blog.ppjys.cn/2020/02/19/20200219_线上服务堆外内存OOM问题/"/>





  <title>线上服务堆外内存OOM问题 | J~杰's Blog</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="default">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband">
      <a href="https://github.com/ppj19891020"><img style="position: absolute; top: 0; left: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_left_green_007200.png" alt="Fork me on GitHub"></a>
    </div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">J~杰's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">人生就一条路，走一步有一步的景观</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-首页">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-分类">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-标签">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-归档">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-关于">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            Search
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="Searching..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="blog.ppjys.cn/2020/02/19/20200219_线上服务堆外内存OOM问题/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="J~杰">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="J~杰's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">线上服务堆外内存OOM问题</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-02-19T17:07:35+08:00">
                2020-02-19
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/快速排查线上问题/" itemprop="url" rel="index">
                    <span itemprop="name">快速排查线上问题</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          
            <span class="post-meta-divider">|</span>
            <span class="page-pv"><i class="fa fa-file-o"></i> 阅读数
            <span class="busuanzi-value" id="busuanzi_value_page_pv" ></span>
            </span>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="1-问题描述"><a href="#1-问题描述" class="headerlink" title="1. 问题描述"></a>1. 问题描述</h2><p>最近我们生产上的消息推送服务不断的爆出内存增长过大导致操作系统kill该进程，并且随着业务量的增长出现的频次越来越高，由去年12月底的半个月出现一次，到现在的一天出现一次。</p>
<p>该服务的业务逻辑就是消息推送，业务方推送消息，服务方通过rocketmq做削峰处理，其中主要通道是个推和apns（使用pushy框架）通道，业务方的全局推送大概在5000w用户左右，每全局推送一次，内存就会增长几百mb，直到jvm进程内存达到5g之后，系统就会出现服务请求没响应或者被守护进程重启等问题。</p>
<p>刚开始的快速解决方案也只能重启，虽然重启能解决问题，但是也没找到根本原因！</p>
<p>##2. 问题排查</p>
<p>由于我们jvm堆内的初始内存和最大内存都是配置成2g ,但是进程的内存达到5g，那就是说堆外占了3g</p>
<blockquote>
<p>-Xms2048m -Xmx2048m</p>
</blockquote>
<p>###2.1）运维平台监控</p>
<p>下面是运维监控平台的cpu和内存资源数据，内存在一直在增长，没有回收释放。</p>
<p><img src="images/oom1.png" alt="oom内存和cpu"></p>
<p>出问题的时候监控应用fullgc情况</p>
<p><img src="images/oom4.png" alt="fullgc情况"></p>
<p>###2.2）NMT监控</p>
<p>接下来我们就一直想知道这个增长的内存到底是啥，我们参考<a href="https://tech.meituan.com/2019/01/03/spring-boot-native-memory-leak.html" target="_blank" rel="noopener">Spring Boot引起的“堆外内存泄漏”排查及经验总结</a>文章来监控堆外内存,然后看了官方文档<a href="https://docs.oracle.com/javase/8/docs/technotes/guides/troubleshoot/tooldescr007.html#BABJGHDB" target="_blank" rel="noopener">How to Monitor VM Internal Memory</a>。</p>
<blockquote>
<p>jvm参数增加 “-XX:NativeMemoryTracking=detail”</p>
<p>然后在jvm启动成功后，执行命令”jcmd pid VM.native_memory baseline”设置基准。</p>
</blockquote>
<p>使用命令<code>jcmd pid VM.native_memory summary.diff</code>查看到的内存分布如下：</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">Native</span> <span class="selector-tag">Memory</span> <span class="selector-tag">Tracking</span>:</span><br><span class="line">Total: reserved=6292013KB +1539438KB, committed=5135497KB +1547890KB</span><br><span class="line"><span class="selector-tag">-</span>                 <span class="selector-tag">Java</span> <span class="selector-tag">Heap</span> (reserved=<span class="number">2097152</span>KB, committed=<span class="number">2097152</span>KB)</span><br><span class="line">                            (<span class="attribute">mmap</span>: reserved=<span class="number">2097152</span>KB, committed=<span class="number">2097152</span>KB)</span><br><span class="line"><span class="selector-tag">-</span>                     <span class="selector-tag">Class</span> (reserved=<span class="number">1195883</span>KB +<span class="number">2229</span>KB, committed=<span class="number">164035</span>KB +<span class="number">2229</span>KB)</span><br><span class="line">                            (classes <span class="number">#24637</span>)</span><br><span class="line">                            (malloc=<span class="number">14187</span>KB +<span class="number">181</span>KB <span class="number">#58583</span> -<span class="number">3174</span>)</span><br><span class="line">                            (<span class="attribute">mmap</span>: reserved=<span class="number">1181696</span>KB +<span class="number">2048</span>KB, committed=<span class="number">149848</span>KB +<span class="number">2048</span>KB)</span><br><span class="line"><span class="selector-tag">-</span>                    <span class="selector-tag">Thread</span> (reserved=<span class="number">330857</span>KB +<span class="number">16399</span>KB, committed=<span class="number">330857</span>KB +<span class="number">16399</span>KB)</span><br><span class="line">                            (thread <span class="number">#625</span> +<span class="number">32</span>)</span><br><span class="line">                            (<span class="attribute">stack</span>: reserved=<span class="number">328076</span>KB +<span class="number">16512</span>KB, committed=<span class="number">328076</span>KB +<span class="number">16512</span>KB)</span><br><span class="line">                            (malloc=<span class="number">2049</span>KB +<span class="number">105</span>KB <span class="number">#3129</span> +<span class="number">160</span>)</span><br><span class="line">                            (arena=<span class="number">732</span>KB -<span class="number">218</span> <span class="number">#1246</span> +<span class="number">64</span>)</span><br><span class="line"><span class="selector-tag">-</span>                      <span class="selector-tag">Code</span> (reserved=<span class="number">269720</span>KB -<span class="number">4533</span>KB, committed=<span class="number">145052</span>KB +<span class="number">3919</span>KB)</span><br><span class="line">                            (malloc=<span class="number">20120</span>KB -<span class="number">4533</span>KB <span class="number">#22197</span> -<span class="number">10586</span>)</span><br><span class="line">                            (<span class="attribute">mmap</span>: reserved=<span class="number">249600</span>KB, committed=<span class="number">124932</span>KB +<span class="number">8452</span>KB)</span><br><span class="line"><span class="selector-tag">-</span>                        <span class="selector-tag">GC</span> (reserved=<span class="number">85877</span>KB -<span class="number">1</span>KB, committed=<span class="number">85877</span>KB -<span class="number">1</span>KB)</span><br><span class="line">                            (malloc=<span class="number">9253</span>KB -<span class="number">1</span>KB <span class="number">#856</span> -<span class="number">42</span>)</span><br><span class="line">                            (<span class="attribute">mmap</span>: reserved=<span class="number">76624</span>KB, committed=<span class="number">76624</span>KB)</span><br><span class="line"><span class="selector-tag">-</span>                  <span class="selector-tag">Compiler</span> (reserved=<span class="number">1753</span>KB -<span class="number">159</span>KB, committed=<span class="number">1753</span>KB -<span class="number">159</span>KB)</span><br><span class="line">                            (malloc=<span class="number">1623</span>KB -<span class="number">159</span>KB <span class="number">#2892</span> -<span class="number">1291</span>)</span><br><span class="line">                            (arena=<span class="number">131</span>KB <span class="number">#6</span>)</span><br><span class="line"><span class="selector-tag">-</span>                  <span class="selector-tag">Internal</span> (reserved=<span class="number">2267668</span>KB +<span class="number">1520485</span>KB, committed=<span class="number">2267668</span>KB +<span class="number">1520485</span>KB)</span><br><span class="line">                            (malloc=<span class="number">2267636</span>KB +<span class="number">1520485</span>KB <span class="number">#39668</span> +<span class="number">996</span>)</span><br><span class="line">                            (<span class="attribute">mmap</span>: reserved=<span class="number">32</span>KB, committed=<span class="number">32</span>KB)</span><br><span class="line"><span class="selector-tag">-</span>                    <span class="selector-tag">Symbol</span> (reserved=<span class="number">30690</span>KB +<span class="number">10</span>KB, committed=<span class="number">30690</span>KB +<span class="number">10</span>KB)</span><br><span class="line">                            (malloc=<span class="number">26686</span>KB +<span class="number">10</span>KB <span class="number">#273270</span> +<span class="number">61</span>)</span><br><span class="line">                            (arena=<span class="number">4004</span>KB <span class="number">#1</span>)</span><br><span class="line"><span class="selector-tag">-</span>    <span class="selector-tag">Native</span> <span class="selector-tag">Memory</span> <span class="selector-tag">Tracking</span> (reserved=<span class="number">7216</span>KB +<span class="number">16</span>KB, committed=<span class="number">7216</span>KB +<span class="number">16</span>KB)</span><br><span class="line">                            (malloc=<span class="number">766</span>KB +<span class="number">190</span>KB <span class="number">#10648</span> +<span class="number">2568</span>)</span><br><span class="line">                            (tracking overhead=<span class="number">6450</span>KB -<span class="number">173</span>KB)</span><br><span class="line"><span class="selector-tag">-</span>               <span class="selector-tag">Arena</span> <span class="selector-tag">Chunk</span> (reserved=<span class="number">5196</span>KB +<span class="number">4991</span>KB, committed=<span class="number">5196</span>KB +<span class="number">4991</span>KB)</span><br><span class="line">                            (malloc=<span class="number">5196</span>KB +<span class="number">4991</span>KB)</span><br></pre></td></tr></table></figure>
<p>发现增长的区域居然是Internal区域，刚开始感到一脸疑惑，后来在网上看到<code>堆外内存申请也是属于Internal区域</code>，才觉得应该是什么中间件使用了堆外内存导致的内存泄漏。</p>
<p>###2.3）pmap查看内存分配情况</p>
<p> 通过linux工具查看进程的内存映射</p>
<blockquote>
<p>pmap -x 11305|sort -k 3 -n -r </p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="selector-tag">----------------</span> <span class="selector-tag">-------</span> <span class="selector-tag">-------</span> <span class="selector-tag">-------</span> </span><br><span class="line">&gt; <span class="selector-tag">0000000080000000</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span> <span class="selector-tag">rw---</span>   <span class="selector-attr">[ anon ]</span></span><br><span class="line">&gt; <span class="selector-tag">0000000101100000</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span> <span class="selector-tag">-----</span>   <span class="selector-attr">[ anon ]</span></span><br><span class="line">&gt; <span class="selector-tag">0000000101100000</span> <span class="selector-tag">1031168</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span> <span class="selector-tag">-----</span>   <span class="selector-attr">[ anon ]</span></span><br><span class="line">&gt; <span class="selector-tag">000055f7262ed000</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span> <span class="selector-tag">r-x--</span> <span class="selector-tag">java</span></span><br><span class="line">&gt; <span class="selector-tag">000055f7264ed000</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span> <span class="selector-tag">r----</span> <span class="selector-tag">java</span></span><br><span class="line">&gt; <span class="selector-tag">000055f7264ee000</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span> <span class="selector-tag">rw---</span> <span class="selector-tag">java</span></span><br><span class="line">&gt; <span class="selector-tag">000055f728243000</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span> <span class="selector-tag">rw---</span>   <span class="selector-attr">[ anon ]</span></span><br><span class="line">&gt; <span class="selector-tag">00007f6970000000</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span> <span class="selector-tag">rw---</span>   <span class="selector-attr">[ anon ]</span></span><br><span class="line">&gt; <span class="selector-tag">00007f6973003000</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span> <span class="selector-tag">-----</span>   <span class="selector-attr">[ anon ]</span></span><br><span class="line">&gt; <span class="selector-tag">00007f6973003000</span>   <span class="selector-tag">16372</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span> <span class="selector-tag">-----</span>   <span class="selector-attr">[ anon ]</span></span><br><span class="line">&gt; <span class="selector-tag">00007f6974000000</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span> <span class="selector-tag">rw---</span>   <span class="selector-attr">[ anon ]</span></span><br><span class="line">&gt; <span class="selector-tag">00007f6977010000</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span> <span class="selector-tag">-----</span>   <span class="selector-attr">[ anon ]</span></span><br><span class="line">&gt; <span class="selector-tag">00007f6977010000</span>   <span class="selector-tag">16320</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span> <span class="selector-tag">-----</span>   <span class="selector-attr">[ anon ]</span></span><br><span class="line">&gt; <span class="selector-tag">00007f6978000000</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span> <span class="selector-tag">rw---</span>   <span class="selector-attr">[ anon ]</span></span><br><span class="line">&gt; <span class="selector-tag">00007f697b001000</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span> <span class="selector-tag">-----</span>   <span class="selector-attr">[ anon ]</span></span><br><span class="line">&gt; <span class="selector-tag">00007f697b001000</span>   <span class="selector-tag">16380</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span> <span class="selector-tag">-----</span>   <span class="selector-attr">[ anon ]</span></span><br><span class="line">&gt; <span class="selector-tag">00007f697c000000</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span> <span class="selector-tag">rw---</span>   <span class="selector-attr">[ anon ]</span></span><br><span class="line">&gt; <span class="selector-tag">00007f697e001000</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span> <span class="selector-tag">-----</span>   <span class="selector-attr">[ anon ]</span></span><br><span class="line">&gt; <span class="selector-tag">00007f697e001000</span>   <span class="selector-tag">32764</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span> <span class="selector-tag">-----</span>   <span class="selector-attr">[ anon ]</span></span><br><span class="line">&gt; <span class="selector-tag">00007f6980000000</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span> <span class="selector-tag">rw---</span>   <span class="selector-attr">[ anon ]</span></span><br><span class="line">&gt; <span class="selector-tag">00007f6983001000</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span> <span class="selector-tag">-----</span>   <span class="selector-attr">[ anon ]</span></span><br><span class="line">&gt; <span class="selector-tag">00007f6983001000</span>   <span class="selector-tag">16380</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span> <span class="selector-tag">-----</span>   <span class="selector-attr">[ anon ]</span></span><br><span class="line">&gt; <span class="selector-tag">00007f6988000000</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span> <span class="selector-tag">rw---</span>   <span class="selector-attr">[ anon ]</span></span><br><span class="line">&gt; <span class="selector-tag">00007f698b001000</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span> <span class="selector-tag">-----</span>   <span class="selector-attr">[ anon ]</span></span><br><span class="line">&gt; <span class="selector-tag">00007f698b001000</span>   <span class="selector-tag">16380</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span> <span class="selector-tag">-----</span>   <span class="selector-attr">[ anon ]</span></span><br><span class="line">&gt; <span class="selector-tag">00007f698c000000</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span> <span class="selector-tag">rw---</span>   <span class="selector-attr">[ anon ]</span></span><br><span class="line">&gt; <span class="selector-tag">00007f698f001000</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span> <span class="selector-tag">-----</span>   <span class="selector-attr">[ anon ]</span></span><br><span class="line">&gt; <span class="selector-tag">00007f698f001000</span>   <span class="selector-tag">16380</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span> <span class="selector-tag">-----</span>   <span class="selector-attr">[ anon ]</span></span><br><span class="line">&gt; <span class="selector-tag">00007f6990000000</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span> <span class="selector-tag">rw---</span>   <span class="selector-attr">[ anon ]</span></span><br><span class="line">&gt; <span class="selector-tag">00007f6993001000</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span> <span class="selector-tag">-----</span>   <span class="selector-attr">[ anon ]</span></span><br><span class="line">&gt; <span class="selector-tag">00007f6993001000</span>   <span class="selector-tag">16380</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span> <span class="selector-tag">-----</span>   <span class="selector-attr">[ anon ]</span></span><br><span class="line">&gt; <span class="selector-tag">00007f6994000000</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span> <span class="selector-tag">rw---</span>   <span class="selector-attr">[ anon ]</span></span><br><span class="line">&gt; <span class="selector-tag">00007f6997001000</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span> <span class="selector-tag">-----</span>   <span class="selector-attr">[ anon ]</span></span><br><span class="line">&gt; <span class="selector-tag">00007f6997001000</span>   <span class="selector-tag">16380</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span> <span class="selector-tag">-----</span>   <span class="selector-attr">[ anon ]</span></span><br><span class="line">&gt; <span class="selector-tag">00007f6998000000</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span> <span class="selector-tag">rw---</span>   <span class="selector-attr">[ anon ]</span></span><br><span class="line">&gt; <span class="selector-tag">00007f699b001000</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span> <span class="selector-tag">-----</span>   <span class="selector-attr">[ anon ]</span></span><br><span class="line">&gt; <span class="selector-tag">00007f699b001000</span>   <span class="selector-tag">16380</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span> <span class="selector-tag">-----</span>   <span class="selector-attr">[ anon ]</span></span><br><span class="line">&gt; <span class="selector-tag">00007f699c000000</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span> <span class="selector-tag">rw---</span>   <span class="selector-attr">[ anon ]</span></span><br><span class="line">&gt; <span class="selector-tag">00007f699f001000</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span> <span class="selector-tag">-----</span>   <span class="selector-attr">[ anon ]</span></span><br><span class="line">&gt; <span class="selector-tag">00007f699f001000</span>   <span class="selector-tag">16380</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span> <span class="selector-tag">-----</span>   <span class="selector-attr">[ anon ]</span></span><br><span class="line">&gt; <span class="selector-tag">00007f69a0000000</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span> <span class="selector-tag">rw---</span>   <span class="selector-attr">[ anon ]</span></span><br><span class="line">&gt; <span class="selector-tag">00007f69a3001000</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span> <span class="selector-tag">-----</span>   <span class="selector-attr">[ anon ]</span></span><br><span class="line">&gt; <span class="selector-tag">00007f69a3001000</span>   <span class="selector-tag">16380</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span> <span class="selector-tag">-----</span>   <span class="selector-attr">[ anon ]</span></span><br><span class="line">&gt; <span class="selector-tag">00007f69a4000000</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span> <span class="selector-tag">rw---</span>   <span class="selector-attr">[ anon ]</span></span><br><span class="line">&gt; <span class="selector-tag">00007f69a7001000</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span> <span class="selector-tag">-----</span>   <span class="selector-attr">[ anon ]</span></span><br><span class="line">&gt; <span class="selector-tag">00007f69a7001000</span>   <span class="selector-tag">16380</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span> <span class="selector-tag">-----</span>   <span class="selector-attr">[ anon ]</span></span><br><span class="line">&gt; <span class="selector-tag">00007f69a8000000</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span> <span class="selector-tag">rw---</span>   <span class="selector-attr">[ anon ]</span></span><br><span class="line">&gt; <span class="selector-tag">00007f69ab001000</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span> <span class="selector-tag">-----</span>   <span class="selector-attr">[ anon ]</span></span><br><span class="line">&gt; <span class="selector-tag">00007f69ab001000</span>   <span class="selector-tag">16380</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span> <span class="selector-tag">-----</span>   <span class="selector-attr">[ anon ]</span></span><br><span class="line">&gt; <span class="selector-tag">00007f69ada9a000</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span> <span class="selector-tag">rw---</span>   <span class="selector-attr">[ anon ]</span></span><br><span class="line">&gt; <span class="selector-tag">00007f69afa9c000</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span> <span class="selector-tag">-----</span>   <span class="selector-attr">[ anon ]</span></span><br><span class="line">&gt; <span class="selector-tag">00007f69afa9c000</span>      <span class="selector-tag">12</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span> <span class="selector-tag">-----</span>   <span class="selector-attr">[ anon ]</span></span><br><span class="line">&gt; <span class="selector-tag">00007f69afa9f000</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span> <span class="selector-tag">rw---</span>   <span class="selector-attr">[ anon ]</span></span><br><span class="line">&gt; <span class="selector-tag">00007f69afb1d000</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span> <span class="selector-tag">-----</span>   <span class="selector-attr">[ anon ]</span></span><br><span class="line">&gt; <span class="selector-tag">00007f69afb1d000</span>      <span class="selector-tag">12</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span> <span class="selector-tag">-----</span>   <span class="selector-attr">[ anon ]</span></span><br><span class="line">&gt; <span class="selector-tag">00007f69afb20000</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span> <span class="selector-tag">rw---</span>   <span class="selector-attr">[ anon ]</span></span><br><span class="line">&gt; <span class="selector-tag">00007f69afb9e000</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span> <span class="selector-tag">-----</span>   <span class="selector-attr">[ anon ]</span></span><br><span class="line">&gt; <span class="selector-tag">00007f69afb9e000</span>      <span class="selector-tag">12</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span> <span class="selector-tag">-----</span>   <span class="selector-attr">[ anon ]</span></span><br><span class="line">&gt; <span class="selector-tag">00007f69afba1000</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span> <span class="selector-tag">rw---</span>   <span class="selector-attr">[ anon ]</span></span><br><span class="line">&gt; <span class="selector-tag">00007f69afc1f000</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span> <span class="selector-tag">-----</span>   <span class="selector-attr">[ anon ]</span></span><br><span class="line">&gt; <span class="selector-tag">00007f69afc1f000</span>      <span class="selector-tag">12</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span> <span class="selector-tag">-----</span>   <span class="selector-attr">[ anon ]</span></span><br><span class="line">&gt; <span class="selector-tag">00007f69afc22000</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span> <span class="selector-tag">rw---</span>   <span class="selector-attr">[ anon ]</span></span><br><span class="line">&gt; <span class="selector-tag">00007f69afda2000</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span>       <span class="selector-tag">0</span> <span class="selector-tag">-----</span>   <span class="selector-attr">[ anon ]</span></span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<p>备注：由于篇幅问题，该地方只截取了部分。</p>
<p>从以上也没看出有啥特别多的内存块，所以这里也不好怀疑。</p>
</blockquote>
<h3 id="2-4）操作系统工具分析"><a href="#2-4）操作系统工具分析" class="headerlink" title="2.4）操作系统工具分析"></a>2.4）操作系统工具分析</h3><p>由于操作系统监控运维不给装，我们也就放弃这方面的定位了，这边就写一下大概的思路。</p>
<blockquote>
<p>1.使用strace去追踪系统调用 </p>
<p>2.使用GDB去dump可疑内存 </p>
<p>3.使用jstack去查看对应的线程</p>
</blockquote>
<p>###2.5）内存堆栈分析</p>
<p>由于系统层面堆栈无法分析，我们只能考虑dump内存，如果是堆外内存，肯定有堆内的引用，此时也只能这样操作。</p>
<blockquote>
<p>jmap -heap pid</p>
<p>jmap -histo:live pid | more</p>
<p>jmap -dump:format=b,file=/filetransfer/heap.hprof</p>
</blockquote>
<p>以下是通过jprofile的分析图</p>
<p><img src="images/oom2.png" alt="大对象图"></p>
<p><img src="images/oom3.png" alt="nioEventLoop引用分析"></p>
<p>经过以上分析我们能分析出堆内存在大对象是apns推送相关，我们苹果推送用的是pushy框架，此时发现需要看关注下业务代码发送逻辑和pushy源码相关。</p>
<p>###2.6）业务代码分析</p>
<p>查阅了pushy的官方文档，发现框架为了提高总的tps，本身做了一层消息缓存功能，以下是官方文档摘录。</p>
<blockquote>
<p>The APNs server allows for (at the time of this writing) 1,500 notifications in flight at any time. If we hit that limit, Pushy will buffer notifications automatically behind the scenes and send them to the server as in-flight notifications are resolved.</p>
</blockquote>
<blockquote>
<p>In short, asynchronous operation allows Pushy to make the most of local resources (especially CPU time) by sending notifications as quickly as possible.</p>
</blockquote>
<p>然后看了业务代码逻辑，<strong>rocketmq消费者消费tps比较高，然后真正推送的时候是直接采用异步的时候推送，这时候导致会存在大量的futuretask回调，而且监听器回调里居然还有while(trysave()){sleep(2000)}方法，导致回调的tps很低，大量的futuretask都积压在内存</strong>，伪代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//发送anps服务器</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">send</span><span class="params">(<span class="keyword">final</span> Notification notification)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">final</span> String topic = notification.getTopic();</span><br><span class="line">  <span class="keyword">final</span> String deviceToken = notification.getDeviceToken();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">final</span> ApnsPayloadBuilder builder = <span class="keyword">new</span> ApnsPayloadBuilder();</span><br><span class="line">  builder</span><br><span class="line">    .setAlertTitle(notification.getTitle())</span><br><span class="line">    .setAlertBody(notification.getDescription()).setMutableContent(<span class="keyword">true</span>)</span><br><span class="line">    .addCustomProperty(<span class="string">"*****"</span>, String.valueOf(notification.getTraceId()));</span><br><span class="line"></span><br><span class="line">  <span class="keyword">final</span> Map&lt;String, Object&gt; properties = CommonHelper.Json2Map(notification.getPayload());</span><br><span class="line">  setProperties(properties, builder);</span><br><span class="line">  <span class="keyword">final</span> String payload = builder.buildWithDefaultMaximumLength();</span><br><span class="line">  <span class="keyword">final</span> Future&lt;PushNotificationResponse&lt;SimpleApnsPushNotification&gt;&gt; notificationResponseFuture =</span><br><span class="line">    client.sendNotification(<span class="keyword">new</span> SimpleApnsPushNotification(deviceToken, topic, payload));</span><br><span class="line"></span><br><span class="line">  notificationResponseFuture.addListener(future -&gt; &#123;</span><br><span class="line">    NotificationStatus status = NotificationStatus.FAILED;</span><br><span class="line">    PushyNotificationService.count.decrementAndGet();</span><br><span class="line">    <span class="keyword">if</span> (future.isSuccess()) &#123;</span><br><span class="line">      <span class="keyword">final</span> PushNotificationResponse&lt;SimpleApnsPushNotification&gt; response =</span><br><span class="line">        (PushNotificationResponse&lt;SimpleApnsPushNotification&gt;) future.get();</span><br><span class="line">      <span class="keyword">if</span> (response.isAccepted()) &#123;</span><br><span class="line">        status = NotificationStatus.RECEIVED;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        log.info(<span class="string">"failed reason: &#123;&#125;, notification: &#123;&#125;"</span>, response.getRejectionReason(),</span><br><span class="line">                 ReflectionToStringBuilder.toString(notification));</span><br><span class="line">        notification.setFailedReason(response.getRejectionReason());</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      status = NotificationStatus.RETRY;</span><br><span class="line">      <span class="keyword">final</span> String errorMessage = future.cause().getMessage();</span><br><span class="line">      <span class="comment">// 处理 apns 证书过期情况</span></span><br><span class="line">      <span class="keyword">if</span> (StringUtil.isNotEmpty(errorMessage) &amp;&amp; errorMessage.contains(ERROR_CERT_EXPIRE)) &#123;</span><br><span class="line">        status = NotificationStatus.FAILED;</span><br><span class="line">        notification.setFailedReason(ERROR_CERT_EXPIRE);</span><br><span class="line">      &#125;</span><br><span class="line">      log.warn(<span class="string">"pushy send notification failed... &#123;&#125;"</span>, errorMessage);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">      notification.setNotificationStatus(status);</span><br><span class="line">      operator.postSendOperate(notification);</span><br><span class="line">    &#125;<span class="keyword">catch</span> (Exception ex)&#123;</span><br><span class="line">      log.error(<span class="string">"apns response error"</span>,ex);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//回调方法</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postSendOperate</span><span class="params">(<span class="keyword">final</span> BatchNotificationWrapper notification)</span> </span>&#123;</span><br><span class="line">  <span class="comment">//省略......</span></span><br><span class="line">  <span class="keyword">while</span> (!messageService.trySave(msg)) &#123;</span><br><span class="line">    CommonHelper.sleep(<span class="number">2000</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//省略......</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最终我们在发送代码里加入限流逻辑和优化回调方法，最终发版上线，观察了1天后还未发现内存异常，不过还需要持续关注，就怕pushy会存在内存泄漏问题。</p>
<h2 id="3-总结"><a href="#3-总结" class="headerlink" title="3.总结"></a>3.总结</h2><p>分析这次堆外内存虽然最终定位到问题，但是心里仍然还有几个疑点：</p>
<ol>
<li>去年12月份的时候就开始出现，那个时候差不多半个月会出现一次，为啥知道今年1月底差不多每1天就会出现一次；</li>
<li>对比过推送的ios设备数，1月份总共增长了20w的设备，总的推送设备量在200w左右，也不觉得是设备数增长带来的问题；</li>
<li>如果不是设备量带来的问题，是不是可能正在和apns服务器交互的tps降级，会不会是由于带宽限制导致tps降低，目前这点也不能查证；</li>
<li>即使是由于这个带来的堆外内存增长，但是在jvm低谷的时候，也会消费完所有的推送消息，为啥进程内存还不会释放；</li>
</ol>

      
    </div>
    
    
    

    

    
      <div>
        <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
  <div>写作是一个学习的过程,感谢你的赞助！</div>
  <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
    <span>Donate</span>
  </button>
  <div id="QR" style="display: none;">

    
      <div id="wechat" style="display: inline-block">
        <img id="wechat_qr" src="/images/wechatpay.png" alt="J~杰 WeChat Pay"/>
        <p>WeChat Pay</p>
      </div>
    

    
      <div id="alipay" style="display: inline-block">
        <img id="alipay_qr" src="/images/alipay.jpg" alt="J~杰 Alipay"/>
        <p>Alipay</p>
      </div>
    

    

  </div>
</div>

      </div>
    

    

    <div>
      
        <div>
    
        <div style="text-align:center;color: #ccc;font-size:14px;">-------------人生就一条路，走一步有一步的景观-------------</div>
    
</div>
      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/线上问题/" rel="tag"> <i class="fa fa-tag"></i> 线上问题</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/09/01/Spring源码构建环境搭建/" rel="next" title="Spring源码构建环境搭建">
                <i class="fa fa-chevron-left"></i> Spring源码构建环境搭建
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">J~杰</p>
              <p class="site-description motion-element" itemprop="description">人生就一条路，走一步有一步的景观</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives">
              
                  <span class="site-state-item-count">39</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">17</span>
                  <span class="site-state-item-name">categories</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">32</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-问题描述"><span class="nav-number">1.</span> <span class="nav-text">1. 问题描述</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-4）操作系统工具分析"><span class="nav-number">1.1.</span> <span class="nav-text">2.4）操作系统工具分析</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-总结"><span class="nav-number">2.</span> <span class="nav-text">3.总结</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">J~杰</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.4</div>



<a href="http://www.miitbeian.gov.cn/">浙ICP备19013166号</a>

        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      <i class="fa fa-user"></i> 访问人数
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      人
    </span>
  

  
    <span class="site-pv">
      <i class="fa fa-eye"></i> 总访问量
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      次
    </span>
  
</div>








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  



<script src="/live2dw/lib/L2Dwidget.min.js?0c58a1486de42ac6cc1c59c7d98ae887"></script><script>L2Dwidget.init({"model":"wanko","bottom":-30,"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/"});</script></body>
</html>
<script type="text/javascript" src="/js/src/love.js"></script>